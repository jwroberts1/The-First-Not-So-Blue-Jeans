<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Simpsons in Fortnite Quiz</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .question-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .question-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question-option.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }

        .question-option.correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .question-option.incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .game-font {
            font-family: 'Bangers', cursive;
        }

        /* New Game Styles */
        #game-canvas {
            background-color: #e0f2fe; /* Light blue sky */
            border: 4px solid #0284c7; /* Sky blue border */
            box-shadow: 0 0 20px rgba(2, 132, 199, 0.5);
        }
        
        .control-button {
            @apply bg-gray-700 text-white p-4 rounded-xl text-2xl font-bold transition-transform transform active:scale-95;
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
        }

        @media (max-width: 1024px) {
            #mobile-controls {
                display: grid !important;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <!-- Navigation Links -->
    <div class="max-w-4xl mx-auto flex justify-between mb-4 text-lg font-semibold">
        <a href="./Spelling.html" class="text-indigo-600 hover:text-indigo-800 underline">
            &larr; Go to Spelling
        </a>
        <a href="./Math.html" class="text-green-600 hover:text-green-800 underline">
            Go to Math &rarr;
        </a>
    </div>

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 sm:p-10 mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">The Simpsons Join Fortnite</h1>
        <p class="text-gray-600 text-center mb-8">Read the passage. Then answer the questions.</p>

        <!-- Timer Section -->
        <div id="timer-container" class="bg-gray-100 p-4 rounded-lg text-center mb-6">
            <p class="text-sm font-semibold text-gray-600">Time Elapsed:</p>
            <p id="timer" class="text-2xl font-bold text-blue-600 mt-1">0:00</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container">
            <div id="passage" class="bg-gray-50 rounded-lg p-6 mb-10 text-gray-700 leading-relaxed text-sm sm:text-base border border-gray-200">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4">Passage: The Great Springfield Glitch</h2>

                <p class="mb-4">It started like any other day on the Fortnite Island. Players were dropping into Tilted Towers, chests were being looted in Retail Row, and somewhere, a banana in a tuxedo was probably driving a sports car off a cliff. High above the island, the Zero Point pulsed quietly, a giant, shimmering orb of pure reality-bending energy. But on this particular Tuesday, it wasn't just pulsing. It was... listening. It had sensed a disturbance, a massive spike of strange, unstable energy from another dimension entirely.</p>
                <p class="mb-6">That dimension was Springfield. And that energy spike? That was Homer Simpson. Down at the Springfield Nuclear Power Plant, Homer was in a panic. He had dropped his last pink-frosted donut behind Console 7G. In a desperate attempt to retrieve it, he had jammed a crowbar into the panel, ignoring the hundreds of flashing red lights and a very large, very clear sign that read: "DO NOT JAM CROWBARS INTO THIS PANEL." A screeching alarm filled the plant as every gauge rocketed into the red. "D'oh!" Homer yelled, just as the core overloaded. A wave of bright, yellow, two-dimensional energy rocketed into the sky, tearing a hole in reality and making a direct connection with the Zero Point.</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">A New Coat of Paint</h3>

                <p class="mb-4">Back on the Fortnite Island, the sky tore open. It wasn't the usual purple, crackling rift. This was a bright, cartoon-yellow hole. The Zero Point pulsed wildly, and then it happened. A wave of cartoon energy washed over the entire island. The realistic pine trees of Weeping Woods suddenly flattened, their bark turning a simple, cartoonish brown and their needles a flat green. The brickwork of Tilted Towers morphed, the skyscrapers twisting into the odd, off-kilter buildings of Springfield's Downtown. The gas station near Salty Springs was replaced, brick for brick, by Apu's Kwik-E-Mart, complete with a Squee-shee machine out front.</p>
                <p class="mb-6">Across the map, the transformation was total. The entire island had *become* Springfield. The quiet suburban houses of Holly Hedges were gone, replaced by a single, familiar house on Evergreen Terrace. The giant, imposing cooling towers of the Nuclear Power Plant now loomed where Steamy Stacks used to be. Even the Battle Bus was different. As it flew over the new map, it was bright red, looked suspiciously like Otto's school bus, and played a rockin' guitar solo instead of the usual techno beat. When the doors opened, it wasn't just Fortnite characters like Jonesy and Peely who jumped. A new set of players, looking very confused, tumbled out into the sky.</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">The Simpsons Have Landed</h3>

                <p class="mb-4">Homer Simpson landed hard, his body making a "boing" sound as he hit the cartoon grass. He stood up, dusted himself off, and looked around in total confusion. "Marge? Kids? Where's my donut? This doesn't look like the plant. Or Moe's. Or my bed." He spotted a blue mushroom on the ground, picked it up, and ate it. "Mmm... tangy." A blue shield shimmered around him. "Ooh! Side effects!"</p>
                <p class="mb-6">Marge landed more gracefully, her blue hair somehow acting as a parachute. "Homer? Homer! Oh, dear, this is not good. This is not good at all. Look at this place, it's a mess! There are chests just lying open, and that purple cloud in the distance looks very ominous. I hope the kids are all right."</p>
                <p class="mb-6">Bart, on the other hand, was having the time of his life. He had landed on his skateboard, immediately grinding down a telephone wire. "Ay, caramba! Look at this place! It's like my video games, but for real!" He spotted a Slingshot on the ground, picked it up, and immediately used it to launch a Stink Bomb at a nearby supply llama. "Eat my shorts, ya furry piÃ±ata!"</p>
                <p class="mb-6">Lisa landed near a small pond, her saxophone case strapped to her back. She was instantly fascinated. "The physics here are all wrong! The gravity seems... lighter. And look at the flora. This place is an ecological and dimensional marvel! I must document this. I wonder if the rift that brought us here created a stable localized singularity..." She was interrupted by a player in a fish costume who handed her a Small Shield Potion. She drank it. "Tastes like blue raspberry. Interesting."</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">Surviving Springfield</h3>

                <p class="mb-4">The first match of the new season began. The Storm Eye started to shrink. "Homie, that purple cloud is getting closer!" Marge yelled, her voice filled with panic. "We have to... 'get in the circle'?" She was reading a helpful tip that had just popped up in her vision.</p>
                <p class="mb-6">The family, plus a non-stop-sucking Maggie, grouped up. They were immediately set upon by another squad. "Oh, no! Strangers!" Marge fretted. Homer, in a panic, tried to build a wall. He fumbled with the controls, creating a single, crooked wooden ramp that immediately fell over. "D'oh! Stupid magic wood!" The enemy player, a default skin, aimed a shotgun at him. But just then, Bart zipped by on his skateboard, landing a perfect no-scope with a hunting rifle. The player dissolved into a pile of loot. "Woo-hoo! Got 'em!" Bart cheered. Lisa, meanwhile, had found a set of Remote Explosives. "If my calculations are correct," she muttered, "the structural integrity of that taco stand is... compromised." She pressed the detonator, and an entire enemy squad was eliminated in the blast.</p>
                <p class="mb-6">They continued toward the circle, which was closing in on the Kwik-E-Mart. Homer was delighted. "Apu! Thank goodness! Give me a six-pack of Duff and a dozen of those pink donuts!" Apu, who had also been pulled into the game, was behind the counter. "Thank you, come again! But sir, all we have is 'Chug Splash' and 'Lard Lad Donuts.' Will that be sufficient?" Homer grabbed the donuts, which healed his health instantly. "Mmm... procedurally-generated donuts."</pre>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">Victory D'oh-yale</h3>

                <p class="mb-4">It came down to the final two squads. The Simpsons, hiding behind the Squee-shee machine, and one other player... a giant, terrifying banana man. Peely. "Oh, Homie, he's so... yellow," Marge whispered. "He looks delicious," Homer whispered back.</p>
                <p class="mb-6">Peely was an expert builder, creating a massive tower in seconds. "We're doomed!" Lisa cried. "His edits are too fast!" Bart tried to shoot at the tower, but Peely kept blocking his shots. All seemed lost. Homer, deciding he couldn't take the stress, tried to sneak away to find the power plant. He jumped into the family's pink sedan, which had also been rifted in. But as he fumbled for the keys, he accidentally slammed his hand on the horn. *HONK! HOOOONK!*</p>
                <p class="mb-6">The loud, obnoxious sound startled Peely, who peeked out from his tower for just a second. "Now, Bart!" Lisa yelled. Bart, using his slingshot, fired one perfect shot. It hit Peely directly, and the banana warrior exploded into a shower of confetti and loot. A giant, holographic sign lit up the sky: "#1 VICTORY ROYALE." Homer stepped out of the car. "I did it! I honked us to victory!"</Why did Apu tell Homer he didn't have Duff beer?tory. "You all did great, kids! But it's time to go home. This place is not good for Maggie's development."</p>
                
                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">A Cartoonish Goodbye</h3>
                
                <p class="mb-4">As if on cue, the giant yellow rift opened in the sky again. The family gathered together, waving goodbye to a very confused Jonesy. One by one, they were pulled back into the rift, returning to their own dimension. The island began to change back. The cartoon grass faded, the realistic trees returned. Tilted Towers re-assembled itself.</p>
                <p class="mb-6">But the transformation wasn't 100% complete. When the dust settled, the Zero Point had left a few... souvenirs. On a quiet street, the Simpsons' house at 742 Evergreen Terrace remained, a permanent, out-of-place cartoon building in the middle of the realistic map. And downtown, the Kwik-E-Mart was also still there, a new place for players to buy "Slurp Squee-shees" from a holographic Apu. Springfield was gone, but it would never be forgotten. And somewhere, on a desk at the power plant, Homer found a small shield potion, which he immediately tried to drink. "Mmm... floor-flavored."</p>
            </div>

            <div id="questions-container" class="space-y-10">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </div>

            <div class="mt-10 text-center space-x-4">
                <button id="submitBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-600 transition duration-300">
                    Check Answers
                </button>
            </div>
        </div>

        <div id="results" class="mt-8 p-6 rounded-lg text-center font-bold text-lg hidden">
            <p id="scoreText"></p>
            <div class="mt-4 space-x-4">
                <button id="startGameBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 hidden">
                    Congratulations! Play the Chase Game!
                </button>
                <button id="retakeQuizBtn" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300 hidden">
                    Retake Quiz
                </button>
            </div>
        </div>

        <hr class="my-12 border-gray-300">

        <!-- Game Section (Dog Man Chase) -->
        <div id="game-container" class="flex flex-col items-center justify-center min-h-[500px] p-4 bg-gray-100 rounded-lg shadow-inner" style="display: none;">
            <div id="game-info" class="mb-6 w-full max-w-xl text-center text-gray-800 bg-white p-4 rounded-xl border-2 border-blue-400">
                <h1 class="text-3xl font-bold mb-2 header-font text-blue-700">Dog Man Chase!</h1>
                <p class="text-gray-600">Use the arrow keys or buttons to help Dog Man catch Petey! Dodge the bombs!</p>
            </div>
            <div id="game-canvas-container" class="relative w-full max-w-xl aspect-square overflow-hidden rounded-lg">
                 <canvas id="game-canvas" class="w-full h-full"></canvas>
            </div>
            <!-- Mobile Controls -->
            <div id="mobile-controls" class="hidden grid grid-cols-3 gap-2 w-48 mt-6">
                <div></div> <!-- Top-left empty -->
                <button id="up-btn" class="control-button w-full">â–²</button>
                <div></div> <!-- Top-right empty -->
                
                <button id="left-btn" class="control-button w-full">â—€</button>
                <div></div> <!-- Middle-center empty -->
                <button id="right-btn" class="control-button w-full">â–¶</button>
                
                <div></div> <!-- Bottom-left empty -->
                <button id="down-btn" class="control-button w-full">â–¼</button>
                <div></div> <!-- Bottom-right empty -->
            </div>


            <div id="win-message" class="modal-overlay hidden">
                 <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <h2 class="text-3xl font-bold mb-4 text-yellow-700 header-font">You Caught Petey!</h2>
                    <p class="text-gray-800 text-lg mb-6">Great job, hero!</p>
                    <button id="playAgainBtn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- QUIZ DATA ---
        // (New questions for "The Simpsons Join Fortnite")
        const allQuestions = [{
            id: 'q1',
            questionText: 'What caused the rift to open over Springfield?',
            options: [
                { value: 'A', text: 'Bart\'s slingshot backfired.' }, 
                { value: 'B', text: 'Homer dropped his donut behind a panel and used a crowbar.' }, 
                { value: 'C', 'text': 'Lisa was practicing her saxophone too loudly.' }, 
                { value: 'D', text: 'The Battle Bus crashed into the Power Plant.' }
            ],
            type: 'radio'
        }, {
            id: 'q2',
            questionText: 'What was the first Springfield building to replace one on the Fortnite map?',
            options: [
                { value: 'A', text: 'Moe\'s Tavern' }, 
                { value: 'B', text: 'The Kwik-E-Mart' }, 
                { value: 'C', text: 'The Simpsons\' House' }, 
                { value: 'D', text: 'Tilted Towers' }
            ],
            type: 'radio'
        }, {
            id: 'q3',
            questionText: 'What was Homer looking for when he first landed on the island?',
            options: [
                { value: 'A', text: 'His car' }, 
                { value: 'B', text: 'A Slurp Juice' }, 
                { value: 'C', text: 'His donut or Moe\'s' }, 
                { value: 'D', text: 'Marge' }
            ],
            type: 'radio'
        }, {
            id: 'q4',
            questionText: 'How did Bart react to being on the island?',
            options: [
                { value: 'A', text: 'He was scared and hid.' }, 
                { value: 'B', text: 'He thought it was an awesome video game and started playing.' }, 
                { value: 'C', text: 'He started looking for Principal Skinner.' }, 
                { value: 'D', text: 'He tried to build a giant treehouse.' }
            ],
            type: 'radio'
        }, {
            id: 'q5',
            questionText: 'What new Point of Interest (POI) replaced Tilted Towers in the story?',
            options: [
                { value: 'A', text: 'Shelbyville' }, 
                { value: 'B', text: 'Springfield\'s Downtown' }, 
                { value: 'C', text: 'The Krusty Krab' }, 
                { value: 'D', text: 'The Nuclear Power Plant' }
            ],
            type: 'radio'
        }, {
            id: 'q6',
            questionText: 'What item did Homer find at the Kwik-E-Mart that healed him?',
            options: [
                { value: 'A', text: 'A Squee-shee' }, 
                { value: 'B', text: 'Chug Splash' }, 
                { value: 'C', text: 'Duff Beer' }, 
                { value: 'D', text: 'Lard Lad Donuts' }
            ],
            type: 'radio'
        }, {
            id: 'q7',
            questionText: 'Why did Apu tell Homer he didn\'t have Duff beer?',
            options: [
                { value: 'A', text: 'He was sold out.' }, 
                { value: 'B', text: 'All he had was "Chug Splash" and "Lard Lad Donuts".' }, 
                { value: 'C', text: 'He was saving it for Chief Wiggum.' }, 
                { value: 'D', text: 'Homer didn\'t have any V-Bucks.' }
            ],
            type: 'radio'
        }, {
            id: 'q8',
            questionText: 'Who was the final opponent the Simpsons had to defeat to win the Victory Royale?',
            options: [
                { value: 'A', text: 'A player in a fish costume' }, 
                { value: 'B', text: 'Jonesy' }, 
                { value: 'C', text: 'Peely (the banana man)' }, 
                { value: 'D', text: 'Principal Skinner' }
            ],
            type: 'radio'
        }, {
            id: 'q9',
            questionText: 'How did Homer help the family win the final battle?',
            options: [
                { value: 'A', text: 'He built a giant fortress.' }, 
                { value: 'B', text: 'He accidentally honked the car horn, distracting the enemy.' }, 
                { value: 'C', text: 'He ate all the Lard Lad Donuts.' }, 
                { value: 'D', text: 'He threw a Stink Bomb.' }
            ],
            type: 'radio'
        }, {
            id: 'q10',
            questionText: 'What two buildings were left behind on the Fortnite map as permanent POIs?',
            options: [
                { value: 'A', text: 'Moe\'s Tavern and the Power Plant' }, 
                { value: 'B', text: 'The School and the Kwik-E-Mart' }, 
                { value: 'C', text: 'The Simpsons\' house and the Kwik-E-Mart' }, 
                { value: 'D', text: 'Tilted Towers and the Power Plant' } // This line was corrected
            ],
            type: 'radio'
        }];

        // (New correct answers)
        const correctAnswers = {
            q1: "B",
            q2: "B",
            q3: "C",
            q4: "B",
            q5: "B",
            q6: "D",
            q7: "B",
            q8: "C",
            q9: "B",
            q10: "C"
        };
        // --- END OF QUIZ DATA ---


        // DOM elements
        const submitBtn = document.getElementById('submitBtn');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('scoreText');
        const questionsContainer = document.getElementById('questions-container');
        const quizContainer = document.getElementById('quiz-container');
        const gameContainer = document.getElementById('game-container');
        const timerDisplay = document.getElementById('timer');

        // Quiz State
        let startTime;
        let timerInterval;

        // Function to shuffle an array in place (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Timer functions
        function updateTimerDisplay() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = Date.now();
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Renders the quiz questions to the page
        function renderQuiz() {
            questionsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            retakeQuizBtn.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            gameContainer.style.display = 'none';
            quizContainer.style.display = 'block';

            const optionLabels = ['A', 'B', 'C', 'D'];
            // We use allQuestions directly, no shuffling of question order
            // const shuffledQuestions = shuffleArray([...allQuestions]);

            allQuestions.forEach((q, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = q.id;
                questionDiv.className = 'question p-6 rounded-lg shadow-md bg-white border border-gray-200';

                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-lg mb-4';
                questionText.innerHTML = `${questionIndex + 1}. ${q.questionText}`;
                questionDiv.appendChild(questionText);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-4 text-sm sm:text-base';
                questionDiv.appendChild(optionsDiv);

                const shuffledOptions = shuffleArray([...q.options]);
                shuffledOptions.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'question-option block bg-gray-50 p-4 rounded-lg border border-gray-200';
                    const input = document.createElement('input');
                    input.type = q.type;
                    input.name = q.id;
                    input.value = option.value;
                    input.className = 'mr-3';

                    // Find the original label (A, B, C, D) for the shuffled option
                    const originalOption = allQuestions[questionIndex].options.find(o => o.value === option.value);
                    const originalLabel = allQuestions[questionIndex].options.indexOf(originalOption);
                    
                    label.appendChild(input);
                    // We display the option text, not a,b,c,d
                    label.appendChild(document.createTextNode(` ${option.text}`));

                    label.addEventListener('click', () => {
                        if (input.type === 'radio') {
                            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                                radio.parentElement.classList.remove('selected');
                            });
                            label.classList.add('selected');
                            input.checked = true;
                        }
                    });
                    optionsDiv.appendChild(label);
                });
                questionsContainer.appendChild(questionDiv);
            });
            startTimer();
        }

        // Event Listeners for quiz
        submitBtn.addEventListener('click', () => {
            let score = 0;
            let totalQuestions = 0;
            let allAnswered = true;

            document.querySelectorAll('.question-option').forEach(label => {
                label.classList.remove('selected', 'correct-answer', 'incorrect-answer');
            });

            questionsContainer.querySelectorAll('.question').forEach(question => {
                const questionId = question.id;
                const labels = question.querySelectorAll('.question-option');
                const selected = question.querySelector('input[type="radio"]:checked');
                const correctAnswerValue = correctAnswers[questionId];

                if (!selected) {
                    allAnswered = false;
                    return;
                }

                totalQuestions++;
                labels.forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === correctAnswerValue) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selected && selected.value === correctAnswerValue) {
                    score++;
                } else if (selected) {
                    selected.parentElement.classList.add('incorrect-answer');
                }
            });

            if (!allAnswered) {
                // Use a simple message box to inform the user
                showBasicMessage("Please answer all questions before submitting.");
                return;
            }

            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%).`;
            resultsDiv.classList.remove('hidden');
            retakeQuizBtn.classList.remove('hidden');

            if (score === totalQuestions) {
                stopTimer(); // Stop the timer on a perfect score
                const finalTime = timerDisplay.textContent;
                scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%). You completed the quiz in ${finalTime}.`;
                resultsDiv.classList.add('bg-green-100', 'text-green-700');
                resultsDiv.classList.remove('bg-red-100', 'text-red-700');
                startGameBtn.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('bg-red-100', 'text-red-700');
                resultsDiv.classList.remove('bg-green-100', 'text-green-700');
            }
        });

        retakeQuizBtn.addEventListener('click', () => {
            renderQuiz();
        });

        startGameBtn.addEventListener('click', () => {
            quizContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            initGame();
        });

        // Simple message box to replace alert()
        function showBasicMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'modal-overlay';
            messageBox.innerHTML = `
                <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <p class="text-gray-800 text-lg sm:text-xl mb-4 font-semibold">${message}</p>
                    <button class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- DOG MAN CHASE GAME LOGIC ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const winMessage = document.getElementById('win-message');
        const playAgainBtn = document.getElementById('playAgainBtn');

        let isGameActive = false;
        let animationFrameId;
        const keys = {};

        const player = { x: 0, y: 0, width: 40, height: 40, speed: 4, symbol: 'ðŸ¶' };
        const petey = { x: 0, y: 0, width: 40, height: 40, speed: 2, symbol: 'ðŸ±' };
        const obstacles = [];
        const obstacleSize = 20;
        let peteyThrowInterval;

        function resetGame() {
            // Stop any active game processes
            isGameActive = false;
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            clearInterval(peteyThrowInterval);

            // Hide win message and clear obstacles
            winMessage.classList.add('hidden');
            obstacles.length = 0;

            // Set initial positions for drawing during countdown
            player.x = 50;
            player.y = canvas.height / 2 - player.height / 2;
            petey.x = canvas.width - 50 - petey.width;
            petey.y = canvas.height / 2 - petey.height / 2;

            function drawStaticFrame() {
                if (!ctx) return; // Add guard clause
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#65a30d'; // Grassy green
                ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
                ctx.font = '40px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(player.symbol, player.x + player.width / 2, player.y + player.height / 2);
                ctx.fillText(petey.symbol, petey.x + petey.width / 2, petey.y + petey.height / 2);
            }

            function drawCountdownText(text) {
                drawStaticFrame(); // Draw the background first
                if (!ctx) return; // Add guard clause
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.font = 'bold 96px Bangers, cursive';
                ctx.fillStyle = '#ffffff';
                ctx.strokeStyle = '#27272a';
                ctx.lineWidth = 6;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(text, canvas.width / 2, canvas.height / 2);
                ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            }

            let count = 3;
            drawCountdownText(count); // Draw initial "3"

            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    drawCountdownText(count);
                } else if (count === 0) {
                    drawCountdownText('GO!');
                } else {
                    clearInterval(countdownInterval);
                    // --- START THE ACTUAL GAME ---
                    isGameActive = true;
                    if (!animationFrameId) {
                        gameLoop();
                    }
                    peteyThrowInterval = setInterval(() => {
                        if (!isGameActive) return;
                        obstacles.push({
                            x: petey.x,
                            y: petey.y + petey.height / 2,
                            width: obstacleSize,
                            height: obstacleSize,
                            speed: 5,
                            symbol: 'ðŸ’£'
                        });
                    }, 1200);
                }
            }, 1000);
        }
        
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function gameLoop() {
            if (!isGameActive) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }

            // Update player position
            if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
            if (keys['ArrowDown'] && player.y < canvas.height - player.height) player.y += player.speed;
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;

            // Update Petey's position (simple AI)
            if (player.y < petey.y && petey.y > 0) {
                petey.y -= petey.speed;
            } else if (player.y > petey.y && petey.y < canvas.height - petey.height) {
                petey.y += petey.speed;
            }

            // Update obstacles
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                obstacle.x -= obstacle.speed;
                if (obstacle.x + obstacle.width < 0) {
                    obstacles.splice(i, 1); // Remove obstacle if it's off-screen
                }
            }

            // Check for collisions
            // 1. Dog Man hits a bomb
            for (const obstacle of obstacles) {
                if (checkCollision(player, obstacle)) {
                    resetGame(); // Restart the game
                    return; // Exit loop for this frame
                }
            }
            // 2. Dog Man catches Petey
            if (checkCollision(player, petey)) {
                isGameActive = false;
                winMessage.classList.remove('hidden');
            }

            // --- DRAW EVERYTHING ---
            if (!ctx) return; // Add guard clause
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Draw ground
            ctx.fillStyle = '#65a30d'; // Grassy green
            ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
            
            // Draw characters and obstacles
            ctx.font = '40px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(player.symbol, player.x + player.width / 2, player.y + player.height / 2);
            ctx.fillText(petey.symbol, petey.x + petey.width / 2, petey.y + petey.height / 2);
            
            ctx.font = '20px sans-serif';
            obstacles.forEach(obstacle => {
                 ctx.fillText(obstacle.symbol, obstacle.x + obstacle.width / 2, obstacle.y + obstacle.height / 2);
            });


            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- EVENT LISTENERS FOR GAME ---
        document.addEventListener('keydown', e => {
             if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
                keys[e.key] = true;
            }
        });
        document.addEventListener('keyup', e => { keys[e.key] = false; });
        
        playAgainBtn.addEventListener('click', resetGame);

        // Mobile Controls
        const controlButtons = {
            'up-btn': 'ArrowUp', 'down-btn': 'ArrowDown',
            'left-btn': 'ArrowLeft', 'right-btn': 'ArrowRight'
        };

        Object.keys(controlButtons).forEach(id => {
            const btn = document.getElementById(id);
            if (!btn) return; // Add guard clause in case element isn't found
            const key = controlButtons[id];
            btn.addEventListener('mousedown', (e) => { e.preventDefault(); keys[key] = true; });
            btn.addEventListener('mouseup', (e) => { e.preventDefault(); keys[key] = false; });
            btn.addEventListener('mouseleave', (e) => { keys[key] = false; });
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
        });

        function resizeCanvas() {
            const container = document.getElementById('game-canvas-container');
            if (!container) return; // Add guard clause
            if (!canvas) return; // Add guard clause
            const size = container.clientWidth;
            canvas.width = size;
            canvas.height = size;
            // Don't reset game on resize, let it continue
            // if (isGameActive) {
            //     resetGame();
            // }
        }

        function initGame() {
            resizeCanvas();
            resetGame();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            window.addEventListener('resize', resizeCanvas);
        });
    </script>
</body>

</html>

