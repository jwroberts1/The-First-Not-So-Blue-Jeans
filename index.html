<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Simpsons in Fortnite Quiz</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .question-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .question-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question-option.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }

        .question-option.correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .question-option.incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .game-font {
            font-family: 'Bangers', cursive;
        }

        /* --- NEW GAME STYLES --- */
        #game-canvas {
            background: #87CEEB; /* Sky Blue */
            border-bottom: 60px solid #a0aec0; /* Sidewalk */
            border-left: 4px solid #3b82f6;
            border-right: 4px solid #3b82f6;
            border-top: 4px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(2, 132, 199, 0.5);
            width: 100%;
            height: 100%;
        }
        
        .control-button {
            @apply bg-gray-700 text-white p-4 rounded-xl text-3xl font-bold transition-transform transform active:scale-95;
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
            width: 80px;
            height: 80px;
        }

        @media (max-width: 1024px) {
            #mobile-controls {
                display: flex !important;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <!-- Navigation Links -->
    <div class="max-w-4xl mx-auto flex justify-between mb-4 text-lg font-semibold">
        <a href="./Math.html" class="text-green-600 hover:text-green-800 underline">
            Go to Math &rarr;
        </a>
        <a href="./Spelling.html" class="text-indigo-600 hover:text-indigo-800 underline">
            Go to Spelling &rarr;
        </a>
    </div>

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 sm:p-10 mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">The Simpsons Join Fortnite</h1>
        <p class="text-gray-600 text-center mb-8">Read the passage. Then answer the questions.</p>

        <!-- Timer Section -->
        <div id="timer-container" class="bg-gray-100 p-4 rounded-lg text-center mb-6">
            <p class="text-sm font-semibold text-gray-600">Time Elapsed:</p>
            <p id="timer" class="text-2xl font-bold text-blue-600 mt-1">0:00</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container">
            <div id="passage" class="bg-gray-50 rounded-lg p-6 mb-10 text-gray-700 leading-relaxed text-sm sm:text-base border border-gray-200">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4">Passage: The Springfield Anomaly</h2>

                <p class="mb-4">It started on a Tuesday, which was strange because weird things in Springfield usually happened on Thursdays. Homer Simpson was at the nuclear power plant, dreaming of donuts, when a blinding blue light erupted from the breakroom vending machine. At the same time, Bart was in detention writing "I will not build a Llama out of school supplies" on the chalkboard when the chalk itself zipped out of his hand, flew into the air, and vanished in a tiny blue explosion. Across town, Marge's hair suddenly defied gravity in a new and alarming way, pointing directly at the Kwik-E-Mart, which was now glowing with a strange, pulsing energy. Apu, ever the observer, merely polished the Squishee machine and remarked, "Oh dear, it seems the dimensional rift is leaking again."</p>
                <p class="mb-6">The rift wasn't just leaking; it was merging. The entire town of Springfield—from the tire fire to the 'L' in the Springfield sign—was pulled through a tear in reality. When the light faded, the Simpsons family found themselves standing not on Evergreen Terrace, but on a grassy hill overlooking a chaotic, colorful island. Below them, Tilted Towers stood gleaming, but just to the east, Moe's Tavern was now wedged between two skyscrapers, and the Kwik-E-Mart had replaced a gas station. The Springfield Elementary school bus was half-sunk in Loot Lake, and a giant, pink-frosted donut rolled slowly across a field. A banana with googly eyes waved at them. "Peely!" it said, tipping its... head? Homer, seeing the giant donut, began to drool. "Mmm... forbidden donut."</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">Welcome to the Island</h3>

                <p class="mb-4">"Where are we, Mom?" Lisa asked, adjusting her saxophone. "It looks like some kind of... battle arena!" Marge looked around nervously. "Homer, I don't think we should be here. That giant tomato person is doing a very strange dance, and I don't like the look of that purple cloud in the distance." Before Homer could answer, a loud horn blared. A voice from the sky announced, "The Battle Bus is launching! All personnel prepare for the drop!" A giant, floating blue bus appeared above them. "Bus?" said Bart, his eyes wide with excitement. "This is way cooler than Otto's bus! Ay, Caramba!" Suddenly, the family was warped inside the bus, surrounded by figures in colorful, bizarre outfits. A person in a fish costume gave them a thumbs-up. A knight, a skeleton, and a woman who looked like a rock star were all leaping out of the open door, deploying colorful gliders.</p>
                <p class="mb-6">"D'oh!" yelled Homer as Bart, grinning, grabbed his hand and pulled him out of the bus. "Cannonball!" Bart shouted, though they were thousands of feet in the air. Marge, Lisa, and Maggie followed, their parachutes (which had appeared out of nowhere) deploying automatically. They landed in a messy heap right in front of the newly-relocated Kwik-E-Mart. "Thank you, come again!" Apu's voice rang out from inside. He had already set up shop. The first thing they noticed was the loot. It was everywhere. Little glowing boxes, colorful weapons, and strange bubbling potions. Homer immediately tried to drink a blue potion, which gave him a powerful shield. "Mmm... protective." Bart, meanwhile, found a skateboard—except it was a rocket-powered hoverboard. "This," he said, "is the best day of my life."</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">The Springfield Strategy</h3>

                <p class="mb-4">Lisa, always the strategist, quickly figured out the rules. "Okay, family, it seems we're in some sort of 'Battle Royale.' The goal is to be the last ones standing as that purple 'Storm' closes in. We need to find gear, stick together, and... well, not get eliminated." "Eliminated?" Marge fretted, "Oh, that sounds dreadful! I hope they're just sent to a nice farm upstate." Homer, meanwhile, had found a stash of Chug Jugs and was trying to build a small fort out of tires. It immediately fell over. "Stupid tires!" he grumbled. Bart, on his hoverboard, was already halfway to Tilted Towers, yelling "Eat my shorts!" at a surprised-looking player in a llama costume. "Bart, no!" Marge called, "You'll be late for... whatever this is!"</p>
                <p class="mb-6">The family's first encounter was... not great. A player with a golden helmet and a powerful shotgun rounded the corner of the Kwik-E-Mart. Homer, in a panic, threw a donut at him. It bounced harmlessly off the player's shield. The player aimed his weapon. But just as he was about to fire, Maggie Simpson, who had been quiet all this time, pulled a Chug Sploosh from Marge's hair and hurled it. The splash hit the player, and instead of hurting him, it... confused him. He suddenly dropped his gun and started doing the Floss dance, completely mesmerized. "Huh," said Lisa. "It seems Maggie has a unique crowd-control ability." Seizing the opportunity, Bart zoomed by and used a "Boogie Bomb" he'd found, forcing the player to dance uncontrollably. "Nobody messes with my sister!" he cackled.</p>
                
                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">Surviving the Storm</h3>

                <p class="mb-4">As the purple storm circle began to shrink, the family realized they had to move. They piled into a golf cart they found near the Power Plant (which was now next to a volcano). Homer, naturally, insisted on driving. His driving, which was a menace on the streets of Springfield, was a terrifying force of nature in Fortnite. He drove backward through player-built forts, plowed through a cornfield, and accidentally ran over a chest full of Legendary loot. "Woo-hoo!" he yelled, as they flew off a ramp and landed in a giant bush. "Heh heh. Bush-campers. They'll never find us here."</p>
                <p class="mb-6">Inside the bush, they held a family meeting. "This is chaos," said Lisa. "But I think I'm getting the hang of it. Bart, you're the 'Entry Fragger'—you go in first and cause trouble. Marge, you're our 'Support'—you have all the 'Slurp Juice' and 'Bandages' you've been collecting. Maggie is... our secret weapon. And Dad..." "I'm the driver!" Homer said proudly. "No, Dad," Lisa sighed. "You're the 'Tank.' You just stand there and absorb damage while drinking all those shield potions." Homer beamed. "A tank! Woo-hoo!" Their strategy was put to the test as another team approached. Bart immediately launched himself on a rocket, Homer threw a pile of Slap Berries, and Marge began building a surprisingly sturdy wooden wall, muttering, "This is much easier than re-tiling the kitchen."</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">The Final Circle</h3>

                <p class="mb-4">Soon, it was just the Simpsons and one other player. The final circle had closed in on the giant, pink-frosted donut that had rolled into the center of the map. The last player, a fearsome-looking warrior with a "Reaper" pickaxe, was building a massive tower, looking down on them. "He has the high ground!" Lisa yelled. "It's over!" "Not yet, it isn't!" Bart said. He looked at Homer, who was staring at the giant donut. A single, beautiful thought was forming in Homer's mind. "Donut..." he whispered. He looked at a nearby "Shockwave" grenade. Then he looked at the donut. Then he looked at the player's tower.</p>
                <p class="mb-6">"Bart, I have an idea," Homer said, which immediately made the rest of the family nervous. "Give me that boingy-thing." Homer grabbed the Shockwave grenade, waddled over to the giant donut, and threw the grenade *at the donut*. The resulting explosion sent the *entire* giant donut flying into the air, where it sailed in a beautiful, pink arc right into the enemy player's tower. The tower crumbled under the pastry's immense weight, sending the player falling to the ground. The player, stunned and covered in sprinkles, was now an easy target. The whole family aimed their (mostly common-grade) weapons. "For Springfield!" Lisa shouted. A few seconds later, a glorious, shimmering sign appeared in the sky: "#1 VICTORY ROYALE."</S>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">Back to Reality?</h3>
                
                <p class="mb-4">The family was teleported back to the grassy hill where they started. The island was quiet. The bus was gone. Then, the blue light flashed again. When they could see, they were back on Evergreen Terrace. Everything was normal. The Kwik-E-Mart was back where it belonged. Marge's hair was only mildly defying gravity. "Was that... real?" Lisa wondered. "Did we just win a Battle Royale?" Marge brushed some glitter off her shoulder. "Well, whatever it was, I'm just glad to be home. I've had enough excitement for one day."</p>
                <p class="mb-6">Homer walked into the kitchen and opened the fridge. "No donuts," he sighed. But then, he looked on the counter. Sitting there was a small, golden trophy of a llama. Bart walked in, holding his skateboard. He looked at it, then at Homer. "Think we'll go back, man?" Homer just smiled. "We'll see, boy. We'll see." Back on the island, Peely the banana was cleaning up the wreckage of the giant donut, finding a single, blue, spiked hair. He just shrugged and started to dance.</p>
            </div>

            <div id="questions-container" class="space-y-10">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </div>

            <div class="mt-10 text-center space-x-4">
                <button id="submitBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-600 transition duration-300">
                    Check Answers
                </button>
            </div>
        </div>

        <div id="results" class="mt-8 p-6 rounded-lg text-center font-bold text-lg hidden">
            <p id="scoreText"></p>
            <div class="mt-4 space-x-4">
                <button id="startGameBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 hidden">
                    Congratulations! Play the New Game!
                </button>
                <button id="retakeQuizBtn" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300 hidden">
                    Retake Quiz
                </button>
            </div>
        </div>

        <hr class="my-12 border-gray-300">

        <!-- --- NEW GAME SECTION: Bart's Skateboard Scurry --- -->
        <div id="game-container" class="flex flex-col items-center justify-center min-h-[500px] p-4 bg-gray-100 rounded-lg shadow-inner" style="display: none;">
            
            <div id="game-info" class="mb-4 w-full max-w-xl text-center text-gray-800 bg-white p-4 rounded-xl border-2 border-blue-400">
                <h1 class="text-3xl font-bold mb-2 header-font text-blue-700">Bart's Skateboard Scurry!</h1>
                <p class="text-gray-600">Survive for 60 seconds! Use arrows or buttons to JUMP (▲) and DUCK (▼).</p>
            </div>

            <!-- Game Timer -->
            <div id="game-timer" class="text-4xl font-bold game-font text-yellow-500 mb-4 bg-gray-800 px-4 py-1 rounded-lg border-2 border-yellow-400">
                TIME: 60
            </div>

            <!-- Game Canvas -->
            <div id="game-canvas-container" class="relative w-full max-w-xl aspect-[4/3] overflow-hidden rounded-lg">
                 <canvas id="game-canvas"></canvas>
            </div>

            <!-- Mobile Controls -->
            <div id="mobile-controls" class="hidden flex justify-center space-x-12 w-full mt-6">
                <button id="up-btn" class="control-button">▲</button>
                <button id="down-btn" class="control-button">▼</button>
            </div>

            <!-- Game Over Modal (Replaces old win message) -->
            <div id="game-over-modal" class="modal-overlay hidden">
                 <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <h2 id="modal-title-text" class="text-3xl font-bold mb-4 text-yellow-700 header-font">You Win!</h2>
                    <p id="modal-body-text" class="text-gray-800 text-lg mb-6">Cowabunga! You survived for 60 seconds!</p>
                    <button id="playAgainBtn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Quiz Data
        const allQuestions = [
            {
                id: 'q1',
                questionText: "What was Bart doing when the dimensional rift opened in Springfield?",
                options: [
                    { value: 'A', text: 'Watching TV at home.' },
                    { value: 'B', text: 'Writing on the chalkboard in detention.' },
                    { value: 'C', text: 'Drinking a Squishee at the Kwik-E-Mart.' },
                    { value: 'D', text: 'Riding his skateboard to Tilted Towers.' }
                ],
                type: 'radio'
            },
            {
                id: 'q2',
                questionText: "Which Springfield building got wedged between two skyscrapers on the Fortnite island?",
                options: [
                    { value: 'A', text: 'The Nuclear Power Plant' },
                    { value: 'B', text: 'Springfield Elementary' },
                    { value: 'C', text: 'The Simpson\'s House' },
                    { value: 'D', text: 'Moe\'s Tavern' }
                ],
                type: 'radio'
            },
            {
                id: 'q3',
                questionText: "What did Homer try to do with the giant pink-frosted donut he saw?",
                options: [
                    { value: 'A', text: 'Eat it.' },
                    { value: 'B', text: 'Roll it at an enemy.' },
                    { value: 'C', text: 'Build a fort inside it.' },
                    { value: 'D', text: 'Hide under it.' }
                ],
                type: 'radio'
            },
            {
                id: 'q4',
                questionText: "How did Maggie stop the first enemy player from attacking the family?",
                options: [
                    { value: 'A', text: 'She used a Boogie Bomb.' },
                    { value: 'B', text: 'She built a giant wall.' },
                    { value: 'C', text: 'She threw a Chug Sploosh that made him dance.' },
                    { value: 'D', text: 'She shot a rocket at him.' }
                ],
                type: 'radio'
            },
            {
                id: 'q5',
                questionText: "What role did Lisa give Homer in their 'Springfield Strategy'?",
                options: [
                    { value: 'A', text: 'The Driver' },
                    { value: 'B', text: 'The Entry Fragger' },
                    { value: 'C', text: 'The Tank' },
                    { value: 'D', text: 'The Support' }
                ],
                type: 'radio'
            },
            {
                id: 'q6',
                questionText: "What object did the family use to drive around the island?",
                options: [
                    { value: 'A', text: 'The school bus' },
                    { value: 'B', text: 'A rocket-powered hoverboard' },
                    { value: 'C', text: 'Their pink sedan' },
                    { value: 'D', text: 'A golf cart' }
                ],
                type: 'radio'
            },
            {
                id: 'q7',
                questionText: "How did Homer defeat the final enemy player in the tower?",
                options: [
                    { value: 'A', text: 'He used a Shockwave grenade to launch the giant donut at the tower.' },
                    { value: 'B', text: 'He drove the golf cart through the base of the tower.' },
                    { value: 'C', text: 'He built a taller tower and shot down at the player.' },
                    { value: 'D', text: 'He threw a donut at the player, which knocked him out.' }
                ],
                type: 'radio'
            },
            {
                id: 'q8',
                questionText: "What glorious sign appeared in the sky after they won?",
                options: [
                    { value: 'A', text: 'D\'OH!' },
                    { value: 'B', text: '#1 VICTORY ROYALE' },
                    { value: 'C', text: 'EAT MY SHORTS' },
                    { value: 'D', text: 'YOU WIN!' }
                ],
                type: 'radio'
            },
            {
                id: 'q9',
                questionText: "What did Homer find on the kitchen counter when they returned home?",
                options: [
                    { value: 'A', text: 'A box of donuts.' },
                    { value: 'B', text: 'A golden llama trophy.' },
                    { value: 'C', text: 'A Chug Jug.' },
                    { value: 'D', text: 'A picture of Peely.' }
                ],
                type: 'radio'
            },
            {
                id: 'q10',
                questionText: "Who was the character who waved at the Simpsons when they first arrived?",
                options: [
                    { value: 'A', text: 'A fish in a costume.' },
                    { value: 'B', text: 'A person in a llama costume.' },
                    { value: 'C', text: 'A banana with googly eyes.' },
                    { value: 'D', text: 'A giant tomato person.' }
                ],
                type: 'radio'
            }
        ];

        const correctAnswers = {
            q1: "B",
            q2: "D",
            q3: "A",
            q4: "C",
            q5: "C",
            q6: "D",
            q7: "A",
            q8: "B",
            q9: "B",
            q10: "C"
        };


        // DOM elements
        const submitBtn = document.getElementById('submitBtn');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('scoreText');
        const questionsContainer = document.getElementById('questions-container');
        const quizContainer = document.getElementById('quiz-container');
        const gameContainer = document.getElementById('game-container');
        const timerDisplay = document.getElementById('timer');

        // Quiz State
        let startTime;
        let timerInterval;

        // Function to shuffle an array in place (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Timer functions
        function updateTimerDisplay() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = Date.now();
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Renders the quiz questions to the page
        function renderQuiz() {
            questionsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            retakeQuizBtn.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            gameContainer.style.display = 'none';
            quizContainer.style.display = 'block';

            const optionLabels = ['A', 'B', 'C', 'D'];
            const shuffledQuestions = shuffleArray([...allQuestions]);

            shuffledQuestions.forEach((q, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = q.id;
                questionDiv.className = 'question p-6 rounded-lg shadow-md bg-white border border-gray-200';

                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-lg mb-4';
                questionText.innerHTML = `${questionIndex + 1}. ${q.questionText}`;
                questionDiv.appendChild(questionText);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-4 text-sm sm:text-base';
                questionDiv.appendChild(optionsDiv);

                const shuffledOptions = shuffleArray([...q.options]);
                shuffledOptions.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'question-option block bg-gray-50 p-4 rounded-lg border border-gray-200';
                    const input = document.createElement('input');
                    input.type = q.type;
                    input.name = q.id;
                    input.value = option.value;
                    input.className = 'mr-3';

                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${optionLabels[index]}. ${option.text}`));

                    label.addEventListener('click', () => {
                        if (input.type === 'radio') {
                            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                                radio.parentElement.classList.remove('selected');
                            });
                            label.classList.add('selected');
                        }
                    });
                    optionsDiv.appendChild(label);
                });
                questionsContainer.appendChild(questionDiv);
            });
            startTimer();
        }

        // Event Listeners for quiz
        submitBtn.addEventListener('click', () => {
            let score = 0;
            let totalQuestions = 0;
            let allAnswered = true;

            document.querySelectorAll('.question-option').forEach(label => {
                label.classList.remove('selected', 'correct-answer', 'incorrect-answer');
            });

            questionsContainer.querySelectorAll('.question').forEach(question => {
                const questionId = question.id;
                const labels = question.querySelectorAll('.question-option');
                const selected = question.querySelector('input[type="radio"]:checked');
                const correctAnswerValue = correctAnswers[questionId];

                if (!selected) {
                    allAnswered = false;
                    return;
                }

                totalQuestions++;
                labels.forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === correctAnswerValue) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selected && selected.value === correctAnswerValue) {
                    score++;
                } else if (selected) {
                    selected.parentElement.classList.add('incorrect-answer');
                }
            });

            if (!allAnswered) {
                showBasicMessage("Please answer all questions before submitting.");
                return;
            }

            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%).`;
            resultsDiv.classList.remove('hidden');
            retakeQuizBtn.classList.remove('hidden');

            if (score === totalQuestions) {
                stopTimer(); // Stop the timer on a perfect score
                const finalTime = timerDisplay.textContent;
                scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%). You completed the quiz in ${finalTime}.`;
                resultsDiv.classList.add('bg-green-100', 'text-green-700');
                resultsDiv.classList.remove('bg-red-100', 'text-red-700');
                startGameBtn.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('bg-red-100', 'text-red-700');
                resultsDiv.classList.remove('bg-green-100', 'text-green-700');
            }
        });

        retakeQuizBtn.addEventListener('click', () => {
            renderQuiz();
        });

        startGameBtn.addEventListener('click', () => {
            quizContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            initGame();
        });

        // Simple message box to replace alert()
        function showBasicMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'modal-overlay';
            messageBox.innerHTML = `
                <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <p class="text-gray-800 text-lg sm:text-xl mb-4 font-semibold">${message}</p>
                    <button class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- BART'S SKATEBOARD SCURRY GAME LOGIC ---

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameTimerDisplay = document.getElementById('game-timer');
        const gameOverModal = document.getElementById('game-over-modal');
        const modalTitleText = document.getElementById('modal-title-text');
        const modalBodyText = document.getElementById('modal-body-text');
        const playAgainBtn = document.getElementById('playAgainBtn');

        // Game constants
        const sidewalkHeight = 60;
        const playerWidth = 30;
        const playerHeight = 60;
        const playerDuckHeight = 30;
        const jumpPower = -12;
        const gravity = 0.6;
        const obstacleWidth = 20;
        const groundObstacleHeight = 40; // Hydrant
        const airObstacleHeight = 30; // Branch
        
        // Game state variables
        let player;
        let obstacles;
        let gameSpeed;
        let timer;
        let isDucking;
        let keys;
        let gameInterval;
        // let timerInterval; // This was the duplicate declaration
        let spawnInterval;

        function resizeCanvas() {
            const container = document.getElementById('game-canvas-container');
            // Set canvas size based on its container
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // Initialize player state
        function initPlayer() {
            return {
                x: 50,
                y: canvas.height - sidewalkHeight - playerHeight,
                width: playerWidth,
                height: playerHeight,
                velocityY: 0,
                isGrounded: true
            };
        }

        // Draw the player (Bart)
        function drawPlayer() {
            ctx.fillStyle = '#FFD900'; // Simpsons Yellow
            const currentHeight = isDucking ? playerDuckHeight : player.height;
            const currentY = isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y;
            ctx.fillRect(player.x, currentY, player.width, currentHeight);
        }

        // Draw all obstacles
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.type === 'ground' ? '#E53E3E' : '#8B4513'; // Red (hydrant) or Brown (branch)
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });
        }

        // Update player position (jumping and gravity)
        function updatePlayer() {
            player.velocityY += gravity;
            player.y += player.velocityY;
            player.isGrounded = false;

            // Don't fall through the floor
            const floor = canvas.height - sidewalkHeight - (isDucking ? playerDuckHeight : player.height);
            if (player.y > floor) {
                player.y = floor;
                player.velocityY = 0;
                player.isGrounded = true;
            }
        }

        // Update obstacle positions and check for collisions
        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obstacle = obstacles[i];
                obstacle.x -= gameSpeed;

                // Remove if off-screen
                if (obstacle.x + obstacle.width < 0) {
                    obstacles.splice(i, 1);
                    continue;
                }

                // Collision detection
                const playerRect = {
                    x: player.x,
                    y: isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y,
                    width: player.width,
                    height: isDucking ? playerDuckHeight : player.height
                };

                if (
                    playerRect.x < obstacle.x + obstacle.width &&
                    playerRect.x + playerRect.width > obstacle.x &&
                    playerRect.y < obstacle.y + obstacle.height &&
                    playerRect.y + playerRect.height > obstacle.y
                ) {
                    endGame(false); // Player lost
                    return;
                }
            }
        }

        // Spawn new obstacles
        function spawnObstacle() {
            if (gameInterval) { // Only spawn if game is running
                const type = Math.random() < 0.5 ? 'ground' : 'air';
                let obstacle = {
                    x: canvas.width,
                    width: obstacleWidth,
                    type: type
                };

                if (type === 'ground') {
                    obstacle.y = canvas.height - sidewalkHeight - groundObstacleHeight;
                    obstacle.height = groundObstacleHeight;
                } else { // air
                    obstacle.y = canvas.height - sidewalkHeight - playerHeight - airObstacleHeight; // Positioned for ducking
                    obstacle.height = airObstacleHeight;
                }
                obstacles.push(obstacle);
            }
        }
        
        // Main game loop
        function updateGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear sky
            
            // Draw sidewalk
            ctx.fillStyle = '#a0aec0';
            ctx.fillRect(0, canvas.height - sidewalkHeight, canvas.width, sidewalkHeight);

            updatePlayer();
            drawPlayer();
            updateObstacles();
            drawObstacles();
        }

        // End the game (win or lose)
        function endGame(didWin) {
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            clearInterval(spawnInterval);
            gameInterval = null;

            if (didWin) {
                modalTitleText.textContent = "Cowabunga!";
                modalBodyText.textContent = "You survived for 60 seconds! Victory Royale!";
            } else {
                modalTitleText.textContent = "D'oh!";
                modalBodyText.textContent = "You crashed! Try again to get the Victory Royale.";
            }
            gameOverModal.classList.remove('hidden');
        }

        // Start a new game
        function startGame() {
            // Clear any old intervals
            if (gameInterval) clearInterval(gameInterval);
            if (timerInterval) clearInterval(timerInterval);
            if (spawnInterval) clearInterval(spawnInterval);

            resizeCanvas(); // Set canvas size
            
            player = initPlayer();
            obstacles = [];
            gameSpeed = 4;
            timer = 60;
            isDucking = false;
            keys = {};
            gameTimerDisplay.textContent = `TIME: ${timer}`;
            gameOverModal.classList.add('hidden');

            // Start game intervals
            gameInterval = setInterval(updateGame, 1000 / 60); // 60 FPS
            
            // Timer interval
            timerInterval = setInterval(() => {
                timer--;
                gameTimerDisplay.textContent = `TIME: ${timer}`;
                
                // Increase difficulty
                if (timer === 45) {
                    gameSpeed = 5;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1800);
                }
                if (timer === 30) {
                    gameSpeed = 6;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1500);
                }
                if (timer === 15) {
                    gameSpeed = 7;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1200);
                }

                // Win condition
                if (timer <= 0) {
                    endGame(true); // Player won
                }
            }, 1000);

            // Initial obstacle spawn
            spawnInterval = setInterval(spawnObstacle, 2000);
        }

        // Handle keyboard input
        function handleKeyInput(e) {
            if (e.code === 'ArrowUp') {
                e.preventDefault();
                if (player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                if (player.isGrounded) {
                    isDucking = true;
                }
            }
        }
        
        function handleKeyRelease(e) {
             if (e.code === 'ArrowDown') {
                e.preventDefault();
                isDucking = false;
            }
        }
        
        // Handle mobile button input
        function handleTouch(key, isDown) {
             if (key === 'ArrowUp') {
                if (isDown && player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (key === 'ArrowDown') {
                if (isDown && player.isGrounded) {
                    isDucking = true;
                } else {
                    isDucking = false;
                }
            }
        }

        // This function is called when the "Start Game" button is clicked
        function initGame() {
            // Set up event listeners
            document.addEventListener('keydown', handleKeyInput);
            document.addEventListener('keyup', handleKeyRelease);
            
            // Mobile controls
            const upBtn = document.getElementById('up-btn');
            const downBtn = document.getElementById('down-btn');

            // Mouse events
            upBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('mouseup', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });
            downBtn.addEventListener('mouseleave', (e) => { handleTouch('ArrowDown', false); });

            // Touch events
            upBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('touchend', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });

            playAgainBtn.addEventListener('click', startGame);
            
            // Resize canvas once on init, and start the game
            resizeCanvas();
            startGame();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            // Add a resize listener to resize the canvas if the window changes
            window.addEventListener('resize', () => {
                if (gameInterval) {
                    resizeCanvas();
                }
            });
        });
    </script>
</body>

</html>

