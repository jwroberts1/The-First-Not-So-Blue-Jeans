<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Simpsons in Fortnite Quiz</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .question-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .question-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question-option.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }

        .question-option.correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .question-option.incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .game-font {
            font-family: 'Bangers', cursive;
        }

        /* --- NEW GAME STYLES --- */
        #game-canvas {
            background: #87CEEB; /* Sky Blue */
            border-bottom: 60px solid #a0aec0; /* Sidewalk */
            border-left: 4px solid #3b82f6;
            border-right: 4px solid #3b82f6;
            border-top: 4px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(2, 132, 199, 0.5);
            width: 100%;
            height: 100%;
        }
        
        .control-button {
            @apply bg-gray-700 text-white p-4 rounded-xl text-3xl font-bold transition-transform transform active:scale-95;
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
            width: 80px;
            height: 80px;
        }

        @media (max-width: 1024px) {
            #mobile-controls {
                display: flex !important;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center; /* Corrected 'align: center' */
        }

        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <!-- Navigation Links -->
    <div class="max-w-4xl mx-auto flex justify-between mb-4 text-lg font-semibold">
        <a href="./Math.html" class="text-green-600 hover:text-green-800 underline">
            Go to Math &rarr;
        </a>
        <a href="./Spelling.html" class="text-indigo-600 hover:text-indigo-800 underline">
            Go to Spelling &rarr;
        </a>
    </div>

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 sm:p-10 mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">The Llama-Nado Loot-astrophe</h1>
        <p class="text-gray-600 text-center mb-8">Read the passage. Then answer the questions.</p>

        <!-- Timer Section -->
        <div id="timer-container" class="bg-gray-100 p-4 rounded-lg text-center mb-6">
            <p class="text-sm font-semibold text-gray-600">Time Elapsed:</p>
            <p id="timer" class="text-2xl font-bold text-blue-600 mt-1">0:00</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container">
            <div id="passage" class="bg-gray-50 rounded-lg p-6 mb-10 text-gray-700 leading-relaxed text-sm sm:text-base border border-gray-200">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4">Passage: The Llama-Nado Loot-astrophe</h2>

                <p class="mb-4">It had been a few weeks since the Simpsons' first Victory Royale, and life in Springfield had become a strange hybrid of reality and... well, whatever Fortnite was. The Kwik-E-Mart now randomly sold 'Chug Splashes' next to the Squishees, and Principal Skinner had taken to hiding in bushes around the schoolyard. But the relative peace was shattered one morning by a sound that was half-tornado siren, half-llama 'hee-haw.' A giant, purple-and-blue tornado, swirling with llama heads, descended on the town. Homer, who was on the roof trying to get a signal for his TV, watched in horror as the Llama-Nado's wind ripped the 'Lard Lad' donut sign right off its hinges and sucked it into the sky.</p>
                <p class="mb-6">Homer’s stomach rumbled like a tiny, angry volcano. "No... no... not the donuts!" he cried. The Llama-Nado wasn't just taking donuts. It zipped across the island (which was still merged with Springfield) and began sucking up *everything*. It vacuumed up all the bananas from Peely's banana stand, all the tacos from Greasy Grove, and, most importantly, every single Lard Lad Donut in existence. The island's economy of tasty snacks was ruined. Peely, the giant banana man, walked up to the Simpsons' house, looking utterly defeated. "They... they took all the bananas," he said, his voice wobbling. Homer put a comforting arm around the giant fruit. "I know how you feel, buddy. They took... *everything*."</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">A Villain's "Excellent" Plan</h3>

                <p class="mb-4">Lisa, naturally, was already investigating. She had sent her 'Recon Scanner' drone (a re-purposed toy helicopter) into the storm. "I'm getting a signal from inside the Llama-Nado," she announced, "It seems to be a giant, floating fortress. And I'm detecting... nuclear energy? And... is that a Smithers?" Deep inside the swirling vortex of loot, Mr. Burns sat in a giant, weaponized armchair, cackling. He had created the 'Loot-Nado 5000' to steal all the island's resources for himself. "Smithers, look!" he chortled. "We've cornered the market on everything! Gold bars, legendary weapons, and... ooh, are those sprinkles?"</p>
                <p class="mb-6">"Yes, sir," Smithers replied nervously, dodging a flying Squishee machine. "But, sir, is it wise to hoard all the island's... well, *everything*? The other players are quite upset. And that giant banana person looks particularly forlorn." "Excellent!" Mr. Burns sneered, tapping his fingers together. "My greed is a fortress, Smithers! No one can touch me up here. Now, release the... uh... release the hounds! Wait, no, I don't have any hounds. Just... just make the wind blow harder!"</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">The Donut-Retrieval Squad</h3>

                <p class="mb-4">"That's it!" Homer declared, his face set with a grim determination. "He took my donuts. This is personal. We're going in." Bart's eyes lit up. "We're gonna fly into a Llama-Nado? Ay, Caramba! This is gonna be awesome!" Marge, however, was less sure. "Homer, no! It's too dangerous! Think of the children!" "I *am* thinking of the children!" Homer retorted. "How will they learn the value of breakfast if all the donuts are gone?" Lisa sighed, but pulled out a map. "Dad's right, Mom. We have to go. Mr. Burns is destabilizing the entire island's snack-based economy. Peely, can you help us?" Peely, wiping a tear from his googly eye, nodded. "For the bananas."</p>
                <p class="mb-6">The plan was simple, which meant Homer had a chance of understanding it. They would use the old 'Battle Bus' (which Otto had hotwired and was now using as a tour bus) and fly it directly into the Llama-Nado. Peely, being a... well, a banana... was apparently a great pilot. They strapped themselves in. The flight was bumpy. The bus was like a leaf in a hurricane, tossed back and forth by the wind. "Woo-hoo!" yelled Homer. "D'oh!" yelled Homer, as his head hit the ceiling. "I'm going to be sick!" Lisa groaned, holding Maggie. "Just keep it steady, Peely!"</p>
                
                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">The Belly of the Beast</h3>

                <p class="mb-4">They burst through the clouds into the eye of the storm. It was a giant, hollow cylinder, and in the center floated a massive fortress made of scrap metal, stolen building parts, and giant, spinning fans. Mr. Burns was on a balcony, yelling into a megaphone. "Get off my property! And my property is *everything*!" "There!" Homer shouted, pointing. "The main donut vault!" A giant, glowing pink donut sign marked the entrance. "Peely, get us as close as you can!" Peely nodded, and with a skillful maneuver, crashed the bus directly through the wall of the fortress. The family piled out, armed with... a collection of very average weapons. Homer had a gray pistol, Marge had a fishing rod, and Bart had a slingshot.</p>
                <p class="mb-6">"Stop them, Smithers!" Burns shrieked. Smithers, sighing, pulled a lever. A horde of 'Supply-Bots' (reprogrammed vacuum cleaners with angry eyebrows drawn on) whirred towards them. "I'll handle this," Marge said, casting her fishing line. It hooked onto a 'Chug Jug' on a high shelf and pulled it down, spilling it all over the bots, which short-circuited. "Hmmph," Marge grumbled. "Just like cleaning up a spill at home." They fought their way to the vault, with Bart using his slingshot to distract guards and Lisa pointing out structural weaknesses. Peely, meanwhile, was having a heartfelt reunion with his stolen banana collection. "I missed you all so much!" he cooed, hugging a bunch of bananas.</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">Greed vs. Teamwork</h3>

                <p class="mb-4">They reached the main control room. Mr. Burns was there, beside a giant red button labeled "STEAL MORE." "You'll never get my precious loot!" he hissed. "It's all mine! I'm rich, I tell you, rich!" "You're just a greedy old man, Mr. Burns!" Lisa shouted over the wind. "You don't need all this stuff! You just don't want anyone *else* to have it!" "That's right, I don't!" Burns snapped. He pushed the "STEAL MORE" button, and the Llama-Nado began to spin even faster. The fortress groaned, and metal plates began to rip off the walls. "Sir, you're overloading the reactor!" Smithers warned. "The whole thing is going to collapse!"</p>
                <p class="mb-6">"Homer, the donuts!" Marge yelled, pointing to the vault, where the Lard Lad sign was flickering. "Donuts..." Homer whispered. He saw the sign, and he saw Mr. Burns. But then he saw Peely, who was trying to shield his bananas from the collapsing ceiling. He saw Lisa holding Maggie, and Bart trying to keep his balance. A new feeling washed over him. It was still hunger, but it was... different. "Family," he mumbled. "And banana-man." He looked at the "STEAL MORE" button, then at a giant "EJECT" button next to it. "Hey, Burns!" Homer yelled. "You forgot one thing!" "What's that, you oaf?" Burns snarled. "This!" Homer shouted, and he belly-flopped onto the "EJECT" button.</p>

                <h3 class="text-lg sm:text-xl font-semibold mt-6 mb-3">A Shower of... Everything</h3>
                
                <p class="mb-4">With a sound like a giant 'sproing,' the bottom of the fortress opened up. All the stolen loot—every banana, every taco, every weapon, and *every single donut*—rained down from the sky, showering the island below. Down on the ground, players looked up in amazement as a glorious storm of free stuff fell upon them. It was the greatest 'Loot Drop' in history. The Llama-Nado, its power source ejected, sputtered and died. The fortress, now empty, began to fall. "To the bus!" Lisa yelled. The family and Peely piled back into the Battle Bus, with Mr. Burns and Smithers clinging to the landing gear. "I hate you all!" Burns shrieked as they flew to safety.</p>
                <p class="mb-6">They landed back in Springfield. The Lard Lad sign crashed right back into its proper place. Peely, now the hero of the island, was given his own banana stand right next to the Kwik-E-Mart. And Homer? He sat on his roof, happily munching on a donut that had landed in his backyard. "You know, Lisa," he said, "I learned something today." "You did, Dad?" Lisa asked, surprised. "Yes," Homer said, taking another bite. "Having all the donuts in the world doesn't mean anything if you don't have... uh... you know... the other... things... to go with it." Lisa smiled. "Close enough, Dad."</p>
            </div>

            <div id="questions-container" class="space-y-10">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </div>

            <div class="mt-10 text-center space-x-4">
                <button id="submitBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-600 transition duration-300">
                    Check Answers
                </button>
            </div>
        </div>

        <div id="results" class="mt-8 p-6 rounded-lg text-center font-bold text-lg hidden">
            <p id="scoreText"></p>
            <div class="mt-4 space-x-4">
                <button id="startGameBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 hidden">
                    Congratulations! Play the New Game!
                </button>
                <button id="retakeQuizBtn" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300 hidden">
                    Retake Quiz
                </button>
            </div>
        </div>

        <hr class="my-12 border-gray-300">

        <!-- --- NEW GAME SECTION: Bart's Skateboard Scurry --- -->
        <div id="game-container" class="flex flex-col items-center justify-center min-h-[500px] p-4 bg-gray-100 rounded-lg shadow-inner" style="display: none;">
            
            <div id="game-info" class="mb-4 w-full max-w-xl text-center text-gray-800 bg-white p-4 rounded-xl border-2 border-blue-400">
                <h1 class="text-3xl font-bold mb-2 header-font text-blue-700">Bart's Skateboard Scurry!</h1>
                <p class="text-gray-600">Survive for 60 seconds! Use arrows or buttons to JUMP (▲) and DUCK (▼).</p>
            </div>

            <!-- Game Timer -->
            <div id="game-timer" class="text-4xl font-bold game-font text-yellow-500 mb-4 bg-gray-800 px-4 py-1 rounded-lg border-2 border-yellow-400">
                TIME: 60
            </div>

            <!-- Game Canvas -->
            <div id="game-canvas-container" class="relative w-full max-w-xl aspect-[4/3] overflow-hidden rounded-lg">
                 <canvas id="game-canvas"></canvas>
            </div>

            <!-- Mobile Controls -->
            <div id="mobile-controls" class="hidden flex justify-center space-x-12 w-full mt-6">
                <button id="up-btn" class="control-button">▲</button>
                <button id="down-btn" class="control-button">▼</button>
            </div>

            <!-- Game Over Modal (Replaces old win message) -->
            <div id="game-over-modal" class="modal-overlay hidden">
                 <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <h2 id="modal-title-text" class="text-3xl font-bold mb-4 text-yellow-700 header-font">You Win!</h2>
                    <p id="modal-body-text" class="text-gray-800 text-lg mb-6">Cowabunga! You survived for 60 seconds!</p>
                    <button id="playAgainBtn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- NEW QUIZ DATA (Based on PDF Question Styles) ---
        const allQuestions = [
            {
                id: 'q1',
                questionText: "Read the sentence from the passage: 'Homer’s stomach rumbled like a tiny, angry volcano.' What does this simile help the reader understand about Homer?",
                options: [
                    { value: 'A', text: 'Homer was very hungry and upset about the donuts.' },
                    { value: 'B', text: 'Homer was about to get sick from the Llama-Nado.' },
                    { value: 'C', text: 'Homer was loud and covered in ash.' },
                    { value: 'D', text: 'Homer had special lava powers.' }
                ],
                type: 'radio'
            },
            {
                id: 'q2',
                questionText: "What is the main lesson of this story?",
                options: [
                    { value: 'A', text: 'Donuts are the most important food.' },
                    { value: 'B', text: 'You should always listen to Mr. Burns.' },
                    { value: 'C', text: 'Teamwork and helping friends is more important than greed.' },
                    { value: 'D', text: 'Flying buses is the safest way to travel.' }
                ],
                type: 'radio'
            },
            {
                id: 'q3',
                questionText: "Read the sentence from the passage: 'My greed is a fortress, Smithers!' What does Mr. Burns mean by this metaphor?",
                options: [
                    { value: 'A', text: 'He lives in a castle made of greed.' },
                    { value: 'B', text: 'He thinks his greed is a weapon that can fight.' },
                    { value: 'C', text: 'He believes his greed protects him and makes him feel safe.' },
                    { value: 'D', text: 'He wants to build a new fortress.' }
                ],
                type: 'radio'
            },
            {
                id: 'q4',
                questionText: "How does Homer's final action of ejecting the loot support the theme of the passage?",
                options: [
                    { value: 'A', text: 'It shows he is good at pushing buttons.' },
                    { value: 'B', text: 'It shows he wanted to get rid of the bananas.' },
                    { value: 'C', text: 'It shows he wanted to break the fortress.' },
                    { value: 'D', text: 'It shows he chose his friends and family over just getting the donuts for himself.' }
                ],
                type: 'radio'
            },
            {
                id: 'q5',
                questionText: "Why did the Simpsons and Peely decide to fly into the Llama-Nado?",
                options: [
                    { value: 'A', text: 'They wanted to steal the fortress for themselves.' },
                    { value: 'B', text: 'They were trying to find a new place to live.' },
                    { value: 'C', text: 'Mr. Burns stole all the donuts and bananas, and they had to get them back.' },
                    { value: 'D', text: 'Bart wanted to see if he could do a skateboard trick inside it.' }
                ],
                type: 'radio'
            },
            {
                id: 'q6',
                questionText: "Read the sentence from the passage: 'The bus was like a leaf in a hurricane, tossed back and forth by the wind.' What does this simile show about the bus ride?",
                options: [
                    { value: 'A', text: 'The bus was painted green.' },
                    { value: 'B', text: 'The ride was very smooth and quiet.' }, // Corrected the typo here
                    { value: 'C', text: 'The bus was out of control and the ride was rough.' },
                    { value: 'D', text: 'The bus was flying gently during autumn.' }
                ],
                type: 'radio'
            },
            {
                id: 'q7',
                questionText: "What caused the Llama-Nado fortress to start collapsing?",
                options: [
                    { value: 'A', text: 'Homer crashed the bus into the main control room.' },
                    { value: 'B', text: 'Mr. Burns overloaded the reactor by pushing the "STEAL MORE" button.' },
                    { value: 'C', text: 'Marge\'s fishing rod pulled the building apart.' },
                    { value: 'D', text: 'Peely and his bananas weighed too much.' }
                ],
                type: 'radio'
            },
            {
                id: 'q8',
                questionText: "What is another important lesson this story shows?",
                options: [
                    { value: 'A', text: 'Being greedy and taking everything for yourself only leads to problems.' },
                    { value: 'B', text: 'Vacuum cleaners make very good guard dogs.' },
                    { value: 'C', text: 'You should never trust a person made of fruit.' },
                    { value: 'D', text: 'It is easy to fly a bus into a tornado.' }
                ],
                type: 'radio'
            },
            {
                id: 'q9',
                questionText: "How did Marge help the team get past Mr. Burns's 'Supply-Bot' guards?",
                options: [
                    { value: 'A', text: 'She used a Boogie Bomb to make them dance.' },
                    { value: 'B', text: 'She built a wall to stop them.' },
                    { value: 'C', text: 'She used her fishing rod to spill Chug Jugs on them, causing a short circuit.' },
                    { value: 'D', text: 'She told them to stop in a very stern voice.' }
                ],
                type: 'radio'
            },
            {
                id: 'q10',
                questionText: "Which sentence from the story *best* states the main theme?",
                options: [
                    { value: 'A', text: '"He looked at the \'STEAL MORE\' button, then at a giant \'EJECT\' button next to it."' },
                    { value: 'B', text: '"You don\'t need all this stuff! You just don\'t want anyone *else* to have it!"' },
                    { value: 'C', text: '"It was a giant, hollow cylinder, and in the center floated a massive fortress."' },
                    { value: 'D', text: '"The island\'s economy of tasty snacks was ruined."' }
                ],
                type: 'radio'
            }
        ];

        // --- NEW Correct Answers ---
        const correctAnswers = {
            q1: "A",
            q2: "C",
            q3: "C",
            q4: "D",
            q5: "C",
            q6: "C",
            q7: "B",
            q8: "A",
            q9: "C",
            q10: "B"
        };


        // --- ALL SCRIPTING BELOW THIS LINE IS UNCHANGED ---

        // DOM elements
        const submitBtn = document.getElementById('submitBtn');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('scoreText');
        const questionsContainer = document.getElementById('questions-container');
        const quizContainer = document.getElementById('quiz-container');
        const gameContainer = document.getElementById('game-container');
        const timerDisplay = document.getElementById('timer');

        // Quiz State
        let startTime;
        let timerInterval;

        // Function to shuffle an array in place (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Timer functions
        function updateTimerDisplay() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = Date.now();
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Renders the quiz questions to the page
        function renderQuiz() {
            questionsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            retakeQuizBtn.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            gameContainer.style.display = 'none';
            quizContainer.style.display = 'block';

            const optionLabels = ['A', 'B', 'C', 'D'];
            const shuffledQuestions = shuffleArray([...allQuestions]);

            shuffledQuestions.forEach((q, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = q.id;
                questionDiv.className = 'question p-6 rounded-lg shadow-md bg-white border border-gray-200';

                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-lg mb-4';
                questionText.innerHTML = `${questionIndex + 1}. ${q.questionText}`;
                questionDiv.appendChild(questionText);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-4 text-sm sm:text-base';
                questionDiv.appendChild(optionsDiv);

                const shuffledOptions = shuffleArray([...q.options]);
                shuffledOptions.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'question-option block bg-gray-50 p-4 rounded-lg border border-gray-200';
                    const input = document.createElement('input');
                    input.type = q.type;
                    input.name = q.id;
                    input.value = option.value;
                    input.className = 'mr-3';

                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${optionLabels[index]}. ${option.text}`));

                    label.addEventListener('click', () => {
                        if (input.type === 'radio') {
                            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                                radio.parentElement.classList.remove('selected');
                            });
                            label.classList.add('selected');
                        }
                    });
                    optionsDiv.appendChild(label);
                });
                questionsContainer.appendChild(questionDiv);
            });
            startTimer();
        }

        // Event Listeners for quiz
        submitBtn.addEventListener('click', () => {
            let score = 0;
            let totalQuestions = 0;
            let allAnswered = true;

            document.querySelectorAll('.question-option').forEach(label => {
                label.classList.remove('selected', 'correct-answer', 'incorrect-answer');
            });

            questionsContainer.querySelectorAll('.question').forEach(question => {
                const questionId = question.id;
                const labels = question.querySelectorAll('.question-option');
                const selected = question.querySelector('input[type="radio"]:checked');
                const correctAnswerValue = correctAnswers[questionId];

                if (!selected) {
                    allAnswered = false;
                    return;
                }

                totalQuestions++;
                labels.forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === correctAnswerValue) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selected && selected.value === correctAnswerValue) {
                    score++;
                } else if (selected) {
                    selected.parentElement.classList.add('incorrect-answer');
                }
            });

            if (!allAnswered) {
                showBasicMessage("Please answer all questions before submitting.");
                return;
            }

            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%).`;
            resultsDiv.classList.remove('hidden');
            retakeQuizBtn.classList.remove('hidden');

            if (score === totalQuestions) {
                stopTimer(); // Stop the timer on a perfect score
                const finalTime = timerDisplay.textContent;
                scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%). You completed the quiz in ${finalTime}.`;
                resultsDiv.classList.add('bg-green-100', 'text-green-700');
                resultsDiv.classList.remove('bg-red-100', 'text-red-700');
                startGameBtn.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('bg-red-100', 'text-red-700');
                resultsDiv.classList.remove('bg-green-100', 'text-green-700');
            }
        });

        retakeQuizBtn.addEventListener('click', () => {
            renderQuiz();
        });

        startGameBtn.addEventListener('click', () => {
            quizContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            initGame();
        });

        // Simple message box to replace alert()
        function showBasicMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'modal-overlay';
            messageBox.innerHTML = `
                <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <p class="text-gray-800 text-lg sm:text-xl mb-4 font-semibold">${message}</p>
                    <button class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- BART'S SKATEBOARD SCURRY GAME LOGIC (UNCHANGED) ---

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameTimerDisplay = document.getElementById('game-timer');
        const gameOverModal = document.getElementById('game-over-modal');
        const modalTitleText = document.getElementById('modal-title-text');
        const modalBodyText = document.getElementById('modal-body-text');
        const playAgainBtn = document.getElementById('playAgainBtn');

        // Game constants
        const sidewalkHeight = 60;
        const playerWidth = 30;
        const playerHeight = 60;
        const playerDuckHeight = 30;
        const jumpPower = -12;
        const gravity = 0.6;
        const obstacleWidth = 20;
        const groundObstacleHeight = 40; // Hydrant
        const airObstacleHeight = 30; // Branch
        
        // Game state variables
        let player;
        let obstacles;
        let gameSpeed;
        let timer;
        let isDucking;
        let keys;
        let gameInterval;
        // let timerInterval; // This was the duplicate declaration
        let spawnInterval;

        function resizeCanvas() {
            const container = document.getElementById('game-canvas-container');
            // Set canvas size based on its container
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // Initialize player state
        function initPlayer() {
            return {
                x: 50,
                y: canvas.height - sidewalkHeight - playerHeight,
                width: playerWidth,
                height: playerHeight,
                velocityY: 0,
                isGrounded: true
            };
        }

        // Draw the player (Bart)
        function drawPlayer() {
            ctx.fillStyle = '#FFD900'; // Simpsons Yellow
            const currentHeight = isDucking ? playerDuckHeight : player.height;
            const currentY = isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y;
            ctx.fillRect(player.x, currentY, player.width, currentHeight);
        }

        // Draw all obstacles
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.type === 'ground' ? '#E53E3E' : '#8B4513'; // Red (hydrant) or Brown (branch)
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });
        }

        // Update player position (jumping and gravity)
        function updatePlayer() {
            player.velocityY += gravity;
            player.y += player.velocityY;
            player.isGrounded = false;

            // Don't fall through the floor
            const floor = canvas.height - sidewalkHeight - (isDucking ? playerDuckHeight : player.height);
            if (player.y > floor) {
                player.y = floor;
                player.velocityY = 0;
                player.isGrounded = true;
            }
        }

        // Update obstacle positions and check for collisions
        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obstacle = obstacles[i];
                obstacle.x -= gameSpeed;

                // Remove if off-screen
                if (obstacle.x + obstacle.width < 0) {
                    obstacles.splice(i, 1);
                    continue;
                }

                // Collision detection
                const playerRect = {
                    x: player.x,
                    y: isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y,
                    width: player.width,
                    height: isDucking ? playerDuckHeight : player.height
                };

                if (
                    playerRect.x < obstacle.x + obstacle.width &&
                    playerRect.x + playerRect.width > obstacle.x &&
                    playerRect.y < obstacle.y + obstacle.height &&
                    playerRect.y + playerRect.height > obstacle.y
                ) {
                    endGame(false); // Player lost
                    return;
                }
            }
        }

        // Spawn new obstacles
        function spawnObstacle() {
            if (gameInterval) { // Only spawn if game is running
                const type = Math.random() < 0.5 ? 'ground' : 'air';
                let obstacle = {
                    x: canvas.width,
                    width: obstacleWidth,
                    type: type
                };

                if (type === 'ground') {
                    obstacle.y = canvas.height - sidewalkHeight - groundObstacleHeight;
                    obstacle.height = groundObstacleHeight;
                } else { // air
                    obstacle.y = canvas.height - sidewalkHeight - playerHeight - airObstacleHeight; // Positioned for ducking
                    obstacle.height = airObstacleHeight;
                }
                obstacles.push(obstacle);
            }
        }
        
        // Main game loop
        function updateGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear sky
            
            // Draw sidewalk
            ctx.fillStyle = '#a0aec0';
            ctx.fillRect(0, canvas.height - sidewalkHeight, canvas.width, sidewalkHeight);

            updatePlayer();
            drawPlayer();
            updateObstacles();
            drawObstacles();
        }

        // End the game (win or lose)
        function endGame(didWin) {
            clearInterval(gameInterval);
            if (timerInterval) clearInterval(timerInterval); // Check if timerInterval exists before clearing
            clearInterval(spawnInterval);
            gameInterval = null;

            if (didWin) {
                modalTitleText.textContent = "Cowabunga!";
                modalBodyText.textContent = "You survived for 60 seconds! Victory Royale!";
            } else {
                modalTitleText.textContent = "D'oh!";
                modalBodyText.textContent = "You crashed! Try again to get the Victory Royale.";
            }
            gameOverModal.classList.remove('hidden');
        }

        // Start a new game
        function startGame() {
            // Clear any old intervals
            if (gameInterval) clearInterval(gameInterval);
            if (timerInterval) clearInterval(timerInterval);
            if (spawnInterval) clearInterval(spawnInterval);

            resizeCanvas(); // Set canvas size
            
            player = initPlayer();
            obstacles = [];
            gameSpeed = 4;
            timer = 60;
            isDucking = false;
            keys = {};
            gameTimerDisplay.textContent = `TIME: ${timer}`;
            gameOverModal.classList.add('hidden');

            // Start game intervals
            gameInterval = setInterval(updateGame, 1000 / 60); // 60 FPS
            
            // Timer interval
            timerInterval = setInterval(() => {
                timer--;
                gameTimerDisplay.textContent = `TIME: ${timer}`;
                
                // Increase difficulty
                if (timer === 45) {
                    gameSpeed = 5;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1800);
                }
                if (timer === 30) {
                    gameSpeed = 6;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1500);
                }
                if (timer === 15) {
                    gameSpeed = 7;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1200);
                }

                // Win condition
                if (timer <= 0) {
                    endGame(true); // Player won
                }
            }, 1000);

            // Initial obstacle spawn
            spawnInterval = setInterval(spawnObstacle, 2000);
        }

        // Handle keyboard input
        function handleKeyInput(e) {
            if (e.code === 'ArrowUp') {
                e.preventDefault();
                if (player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                if (player.isGrounded) {
                    isDucking = true;
                }
            }
        }
        
        function handleKeyRelease(e) {
             if (e.code === 'ArrowDown') {
                e.preventDefault();
                isDucking = false;
            }
        }
        
        // Handle mobile button input
        function handleTouch(key, isDown) {
             if (key === 'ArrowUp') {
                if (isDown && player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (key === 'ArrowDown') {
                if (isDown && player.isGrounded) {
                    isDucking = true;
                } else {
                    isDucking = false;
                }
            }
        }

        // This function is called when the "Start Game" button is clicked
        function initGame() {
            // Set up event listeners
            document.addEventListener('keydown', handleKeyInput);
            document.addEventListener('keyup', handleKeyRelease);
            
            // Mobile controls
            const upBtn = document.getElementById('up-btn');
            const downBtn = document.getElementById('down-btn');

            // Mouse events
            upBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('mouseup', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });
            downBtn.addEventListener('mouseleave', (e) => { handleTouch('ArrowDown', false); });

            // Touch events
            upBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('touchend', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });

            playAgainBtn.addEventListener('click', startGame);
            
            // Resize canvas once on init, and start the game
            resizeCanvas();
            startGame();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            // Add a resize listener to resize the canvas if the window changes
            window.addEventListener('resize', () => {
                if (gameInterval) {
                    resizeCanvas();
                }
            });
        });
    </script>
</body>

</html>
