<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Piece: Chopper's Tale</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .question-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .question-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question-option.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }

        .question-option.correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .question-option.incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .game-font {
            font-family: 'Bangers', cursive;
        }

        /* --- NEW GAME STYLES --- */
        #game-canvas {
            background: #87CEEB; /* Sky Blue */
            border-bottom: 60px solid #a0aec0; /* Sidewalk */
            border-left: 4px solid #3b82f6;
            border-right: 4px solid #3b82f6;
            border-top: 4px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(2, 132, 199, 0.5);
            width: 100%;
            height: 100%;
        }
        
        .control-button {
            @apply bg-gray-700 text-white p-4 rounded-xl text-3xl font-bold transition-transform transform active:scale-95;
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
            width: 80px;
            height: 80px;
        }

        @media (max-width: 1024px) {
            #mobile-controls {
                display: flex !important;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center; /* Corrected 'align: center' */
        }

        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <!-- Navigation Links -->
    <div class="max-w-4xl mx-auto flex justify-between mb-4 text-lg font-semibold">
        <a href="./Math.html" class="text-green-600 hover:text-green-800 underline">
            Go to Math &rarr;
        </a>
        <a href="./Spelling.html" class="text-indigo-600 hover:text-indigo-800 underline">
            Go to Spelling &rarr;
        </a>
    </div>

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 sm:p-10 mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">Chopper: The Doctor of Miracles</h1>
        <p class="text-gray-600 text-center mb-8">A story about finding your herd and curing the world.</p>

        <!-- Timer Section -->
        <div id="timer-container" class="bg-gray-100 p-4 rounded-lg text-center mb-6">
            <p class="text-sm font-semibold text-gray-600">Time Elapsed:</p>
            <p id="timer" class="text-2xl font-bold text-blue-600 mt-1">0:00</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container">
            <div id="passage" class="bg-gray-50 rounded-lg p-6 mb-10 text-gray-700 leading-relaxed text-base sm:text-lg border border-gray-200">
                
                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 1: The Lonely Reindeer</h2>
                <p class="mb-4">Long ago, on a winter island called Drum Island, snow fell 365 days a year. It was always cold, but for a little reindeer named Tony Tony Chopper, the cold wasn't the worst part. The worst part was being alone. Chopper was born different. While all the other reindeer had black noses, Chopper was born with a bright, glowing blue nose. His parents and his herd didn't like that he was different. They made him walk at the back of the group, and eventually, they made him leave the herd entirely.</p>
                <p class="mb-4">Lonely and hungry, Chopper found a strange fruit buried in the snow. It looked like a mushroom with swirls on it. He ate it, hoping it would stop his tummy from growling. But this wasn't just food. It was a Devil Fruit called the Human-Human Fruit! Suddenly, Chopper changed. He could stand on two legs. He gained hands with fingers. He could talk! He thought, "Maybe now that I am like a human, the humans will be my friends."</p>
                <p class="mb-4">He went down to the village, trying to say hello. But the villagers screamed. "Monster! Yeti! Abominable Snowman!" they yelled. They threw rocks at him and chased him into the woods. Chopper cried as he ran back to the snowy mountains. He realized he didn't fit in with the reindeer, and he didn't fit in with the humans. He was a monster to everyone.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 2: The Doctor with the Pink Hat</h2>
                <p class="mb-4">One day, Chopper was lying in the snow, hurt and shivering. A strange man with gray hair that stuck up like spikes found him. This was Dr. Hiluluk. Hiluluk wasn't afraid. He didn't see a monster; he saw a patient. He brought Chopper to his treehouse and bandaged his wounds.</p>
                <p class="mb-4">"You're going to be okay, Tony Tony Chopper," the doctor said, giving him his name. "Tony" for being a sturdy reindeer, and "Chopper" because his antlers could chop down trees. Hiluluk was a "quack" doctor—which means he wasn't very good at medicine—but he had a good heart. He taught Chopper that there is no disease in the world that cannot be cured. He told Chopper about a miracle he had seen in a faraway land: cherry blossoms. He believed that if he could make cherry blossoms bloom on this frozen island, it would heal the sick hearts of the people.</p>
                <p class="mb-4">They lived happily for a year. Hiluluk gave Chopper his favorite pink hat with a white "X" on it. But sadly, Hiluluk was very sick himself. When he passed away, Chopper was heartbroken. He went to the castle on top of the highest mountain to find Dr. Kureha. She was a very scary, very old doctor (she was 139 years old!), but she was a genius. Chopper begged her, "Please teach me medicine! I want to cure every disease! I want to be a doctor who can save anyone!" Kureha agreed, calling him her assistant. For six years, Chopper studied books and mixed herbs, becoming a brilliant doctor.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 3: Setting Sail</h2>
                <p class="mb-4">Life was quiet until a pirate ship arrived. It was the Straw Hat Pirates! Their navigator, Nami, was sick with a high fever, and their captain, Monkey D. Luffy, carried her up the sheer cliffs of the mountain with his bare hands to find a doctor. Chopper helped Dr. Kureha save Nami. </p>
                <p class="mb-4">When Nami woke up, she saw Chopper and thought he was cute. But when Luffy and his cook, Sanji, saw Chopper, they thought he was "emergency food!" They chased him around, but soon they realized he was a cool transforming reindeer. Chopper was scared at first. He hid behind doorframes, but he wasn't very good at it—he hid his eyes but left his whole body sticking out! </p>
                <p class="mb-4">An evil king named Wapol returned to the castle to take it back. Chopper fought bravely to protect Dr. Hiluluk's flag, which flew on top of the castle. He showed off his "Rumble Ball" invention, which let him change into seven different forms, like "Guard Point" (big and fluffy) and "Arm Point" (super strong). Luffy was amazed. After they defeated Wapol, Luffy yelled, "Shut up and let's go!" He didn't care that Chopper was a "monster." He wanted him as a friend. Chopper cried tears of joy. He finally had a herd. As they sailed away, Dr. Kureha used her cannons to launch pink dust into the sky, making it look like Dr. Hiluluk's cherry blossoms were finally blooming over the snow.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 4: A Brave Monster</h2>
                <p class="mb-4">Being a pirate was exciting! Chopper saw deserts, giants, and islands in the sky. In the desert kingdom of Alabasta, Chopper teamed up with Usopp. They fought a mole-human and a batter-human. Chopper realized that even though he was scared, he could be strong for his friends. He said, "I used to hate being a monster. But if being a monster helps Luffy, then I'll be the strongest monster there is!"</p>
                <p class="mb-4">His biggest test came at Enies Lobby. The crew was fighting to save their friend Robin from the government. Chopper had to fight a man named Kumadori who had long hair that attacked like snakes. Chopper was losing. He had no choice. He ate a third Rumble Ball. This was forbidden! </p>
                <p class="mb-4">Chopper grew huge. His antlers became sharp, his fingers became claws, and he stood taller than a giant. He became "Monster Point." He defeated the enemy in one hit, but he lost his mind. He couldn't tell friends from enemies. He destroyed everything in his path until his friend Franky blasted him into the ocean to cool him off. Chopper learned that power is dangerous if you can't control it.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 5: Two Years of Training</h2>
                <p class="mb-4">One day, a powerful enemy named Kuma separated the Straw Hat crew. He sent Chopper flying through the sky for three days and three nights. Chopper landed on the Torino Kingdom, an island where giant birds ruled over the humans. At first, the birds tried to eat him, and the humans tried to cook him! But Chopper realized the birds and humans just misunderstood each other. He used his ability to speak to animals to help them make peace.</p>
                <p class="mb-4">While he was there, Chopper found a library full of advanced medicine books. He realized he needed to get stronger for Luffy. He spent two years studying the island's plants and medicine. He also trained his body. He wanted to use his Monster Point without losing control. "I will become the miracle cure!" he promised.</p>
                <p class="mb-4">When the crew finally met up again, Chopper was different. He wore a new blue hat over his old pink one. He could now change into "Kung Fu Point" to fight with fast moves. He could dig underground with "Horn Point." Best of all, he could use "Monster Point" for three minutes and still talk to his friends!</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 6: Mission in Whole Cake Island</h2>
                <p class="mb-4">The adventures continued until a crisis struck. Sanji, the ship's cook, was taken away to Whole Cake Island to marry the daughter of Big Mom, one of the four strongest pirates in the world. Luffy, Nami, Brook, and Chopper set out to rescue him. Whole Cake Island was made of candy and chocolate, but it was full of danger.</p>
                <p class="mb-4">Chopper and Brook were separated from the others. They found themselves in the "Mirror World," a spooky place that existed inside all the mirrors on the island. They were hunted by a witch named Brûlée. But Chopper had a plan. He realized Brûlée's power could be useful. </p>
                <p class="mb-4">"We can use the mirrors to travel anywhere!" Chopper realized. He and Carrot (a rabbit warrior) came up with a trap. They defeated Brûlée and used her to travel through mirrors to save their friends. Chopper became "Bropper" (a nickname from Sanji) and acted like a big brother to the team. He used his Heavy Point to hold open a giant mirror so his friends could escape a burning castle.</p>
                <p class="mb-4">Even when Big Mom herself attacked the ship, Chopper stood his ground. He used his Guard Point—transforming into a giant ball of fur—to block a massive attack from the Emperor. He was no longer the trembling reindeer hiding behind a door. He was a brave pirate, a genius doctor, and a cherished member of the future Pirate King's crew. And he knew that as long as he had his friends, he would never be lonely again.</p>

            </div>

            <div id="questions-container" class="space-y-10">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </div>

            <div class="mt-10 text-center space-x-4">
                <button id="submitBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-600 transition duration-300 shadow-lg">
                    Check Answers
                </button>
            </div>
        </div>

        <div id="results" class="mt-8 p-6 rounded-lg text-center font-bold text-lg hidden">
            <p id="scoreText"></p>
            <div class="mt-4 space-x-4">
                <button id="startGameBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 shadow-md hidden">
                    Congratulations! Play the New Game!
                </button>
                <button id="retakeQuizBtn" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300 shadow-md hidden">
                    Retake Quiz
                </button>
            </div>
        </div>

        <hr class="my-12 border-gray-300">

        <!-- --- NEW GAME SECTION: Bart's Skateboard Scurry --- -->
        <div id="game-container" class="flex flex-col items-center justify-center min-h-[500px] p-4 bg-gray-100 rounded-lg shadow-inner" style="display: none;">
            
            <div id="game-info" class="mb-4 w-full max-w-xl text-center text-gray-800 bg-white p-4 rounded-xl border-2 border-blue-400">
                <h1 class="text-3xl font-bold mb-2 header-font text-blue-700">Bart's Skateboard Scurry!</h1>
                <p class="text-gray-600">Survive for 60 seconds! Use arrows or buttons to JUMP (▲) and DUCK (▼).</p>
            </div>

            <!-- Game Timer -->
            <div id="game-timer" class="text-4xl font-bold game-font text-yellow-500 mb-4 bg-gray-800 px-4 py-1 rounded-lg border-2 border-yellow-400">
                TIME: 60
            </div>

            <!-- Game Canvas -->
            <div id="game-canvas-container" class="relative w-full max-w-xl aspect-[4/3] overflow-hidden rounded-lg">
                 <canvas id="game-canvas"></canvas>
            </div>

            <!-- Mobile Controls -->
            <div id="mobile-controls" class="hidden flex justify-center space-x-12 w-full mt-6">
                <button id="up-btn" class="control-button">▲</button>
                <button id="down-btn" class="control-button">▼</button>
            </div>

            <!-- Game Over Modal (Replaces old win message) -->
            <div id="game-over-modal" class="modal-overlay hidden">
                 <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <h2 id="modal-title-text" class="text-3xl font-bold mb-4 text-yellow-700 header-font">You Win!</h2>
                    <p id="modal-body-text" class="text-gray-800 text-lg mb-6">Cowabunga! You survived for 60 seconds!</p>
                    <button id="playAgainBtn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- NEW QUIZ DATA (Based on Chopper's Story) ---
        const allQuestions = [
            {
                id: 'q1',
                questionText: "Why was Chopper treated badly by other reindeer when he was young?",
                options: [
                    { value: 'A', text: 'He was too small.' },
                    { value: 'B', text: 'He had a blue nose.' },
                    { value: 'C', text: 'He ate all their food.' },
                    { value: 'D', text: 'He could fly.' }
                ],
                type: 'radio'
            },
            {
                id: 'q2',
                questionText: "What power did the Human-Human Fruit give Chopper?",
                options: [
                    { value: 'A', text: 'The power to breathe fire.' },
                    { value: 'B', text: 'The ability to stretch like rubber.' },
                    { value: 'C', text: 'The ability to walk, talk, and think like a human.' },
                    { value: 'D', text: 'The power to control the weather.' }
                ],
                type: 'radio'
            },
            {
                id: 'q3',
                questionText: "Who was Chopper's first mentor who gave him his name and hat?",
                options: [
                    { value: 'A', text: 'Dr. Kureha' },
                    { value: 'B', text: 'Monkey D. Luffy' },
                    { value: 'C', text: 'Sanji' },
                    { value: 'D', text: 'Dr. Hiluluk' }
                ],
                type: 'radio'
            },
            {
                id: 'q4',
                questionText: "What is Chopper's main job on the Straw Hat ship?",
                options: [
                    { value: 'A', text: 'Cook' },
                    { value: 'B', text: 'Navigator' },
                    { value: 'C', text: 'Doctor' },
                    { value: 'D', text: 'Sniper' }
                ],
                type: 'radio'
            },
            {
                id: 'q5',
                questionText: "What special candy did Chopper invent to increase his transformations?",
                options: [
                    { value: 'A', text: 'Cotton Candy' },
                    { value: 'B', text: 'Rumble Ball' },
                    { value: 'C', text: 'Gum-Gum Fruit' },
                    { value: 'D', text: 'Choco Bar' }
                ],
                type: 'radio'
            },
            {
                id: 'q6',
                questionText: "Who did Chopper and the crew go to save in Whole Cake Island?",
                options: [
                    { value: 'A', text: 'Zoro' },
                    { value: 'B', text: 'Nami' },
                    { value: 'C', text: 'Sanji' },
                    { value: 'D', text: 'Usopp' }
                ],
                type: 'radio'
            },
            {
                id: 'q7',
                questionText: "What strange world did Chopper and Brook fight inside of?",
                options: [
                    { value: 'A', text: 'The Mirror World' },
                    { value: 'B', text: 'The Shadow Realm' },
                    { value: 'C', text: 'The Dessert Kingdom' },
                    { value: 'D', text: 'The Underwater City' }
                ],
                type: 'radio'
            },
            {
                id: 'q8',
                questionText: "What happens when Chopper eats three Rumble Balls (before his training)?",
                options: [
                    { value: 'A', text: 'He falls asleep.' },
                    { value: 'B', text: 'He turns into a giant, uncontrollable Monster Point.' },
                    { value: 'C', text: 'He shrinks to the size of an ant.' },
                    { value: 'D', text: 'He becomes invisible.' }
                ],
                type: 'radio'
            },
            {
                id: 'q9',
                questionText: "How did Chopper feel when Luffy asked him to join the crew?",
                options: [
                    { value: 'A', text: 'Angry' },
                    { value: 'B', text: 'Bored' },
                    { value: 'C', text: 'Wanted and accepted' },
                    { value: 'D', text: 'Hungry' }
                ],
                type: 'radio'
            },
            {
                id: 'q10',
                questionText: "What does Chopper dream of achieving?",
                options: [
                    { value: 'A', text: 'Finding the One Piece' },
                    { value: 'B', text: 'Becoming the world\'s strongest swordsman' },
                    { value: 'C', text: 'Curing any sickness in the world' },
                    { value: 'D', text: 'Drawing a map of the whole world' }
                ],
                type: 'radio'
            }
        ];

        // --- NEW Correct Answers ---
        const correctAnswers = {
            q1: "B",
            q2: "C",
            q3: "D",
            q4: "C",
            q5: "B",
            q6: "C",
            q7: "A",
            q8: "B",
            q9: "C",
            q10: "C"
        };


        // --- ALL SCRIPTING BELOW THIS LINE IS UNCHANGED ---

        // DOM elements
        const submitBtn = document.getElementById('submitBtn');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('scoreText');
        const questionsContainer = document.getElementById('questions-container');
        const quizContainer = document.getElementById('quiz-container');
        const gameContainer = document.getElementById('game-container');
        const timerDisplay = document.getElementById('timer');

        // Quiz State
        let startTime;
        let timerInterval;

        // Function to shuffle an array in place (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Timer functions
        function updateTimerDisplay() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = Date.now();
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Renders the quiz questions to the page
        function renderQuiz() {
            questionsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            retakeQuizBtn.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            gameContainer.style.display = 'none';
            quizContainer.style.display = 'block';

            const optionLabels = ['A', 'B', 'C', 'D'];
            const shuffledQuestions = shuffleArray([...allQuestions]);

            shuffledQuestions.forEach((q, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = q.id;
                questionDiv.className = 'question p-6 rounded-lg shadow-md bg-white border border-gray-200';

                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-lg mb-4';
                questionText.innerHTML = `${questionIndex + 1}. ${q.questionText}`;
                questionDiv.appendChild(questionText);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-4 text-sm sm:text-base';
                questionDiv.appendChild(optionsDiv);

                const shuffledOptions = shuffleArray([...q.options]);
                shuffledOptions.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'question-option block bg-gray-50 p-4 rounded-lg border border-gray-200';
                    const input = document.createElement('input');
                    input.type = q.type;
                    input.name = q.id;
                    input.value = option.value;
                    input.className = 'mr-3';

                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${optionLabels[index]}. ${option.text}`));

                    label.addEventListener('click', () => {
                        if (input.type === 'radio') {
                            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                                radio.parentElement.classList.remove('selected');
                            });
                            label.classList.add('selected');
                        }
                    });
                    optionsDiv.appendChild(label);
                });
                questionsContainer.appendChild(questionDiv);
            });
            startTimer();
        }

        // Event Listeners for quiz
        submitBtn.addEventListener('click', () => {
            let score = 0;
            let totalQuestions = 0;
            let allAnswered = true;

            document.querySelectorAll('.question-option').forEach(label => {
                label.classList.remove('selected', 'correct-answer', 'incorrect-answer');
            });

            questionsContainer.querySelectorAll('.question').forEach(question => {
                const questionId = question.id;
                const labels = question.querySelectorAll('.question-option');
                const selected = question.querySelector('input[type="radio"]:checked');
                const correctAnswerValue = correctAnswers[questionId];

                if (!selected) {
                    allAnswered = false;
                    return;
                }

                totalQuestions++;
                labels.forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === correctAnswerValue) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selected && selected.value === correctAnswerValue) {
                    score++;
                } else if (selected) {
                    selected.parentElement.classList.add('incorrect-answer');
                }
            });

            if (!allAnswered) {
                showBasicMessage("Please answer all questions before submitting.");
                return;
            }

            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%).`;
            resultsDiv.classList.remove('hidden');
            retakeQuizBtn.classList.remove('hidden');

            if (score === totalQuestions) {
                stopTimer(); // Stop the timer on a perfect score
                const finalTime = timerDisplay.textContent;
                scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%). You completed the quiz in ${finalTime}.`;
                resultsDiv.classList.add('bg-green-100', 'text-green-700');
                resultsDiv.classList.remove('bg-red-100', 'text-red-700');
                startGameBtn.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('bg-red-100', 'text-red-700');
                resultsDiv.classList.remove('bg-green-100', 'text-green-700');
            }
        });

        retakeQuizBtn.addEventListener('click', () => {
            renderQuiz();
        });

        startGameBtn.addEventListener('click', () => {
            quizContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            initGame();
        });

        // Simple message box to replace alert()
        function showBasicMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'modal-overlay';
            messageBox.innerHTML = `
                <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <p class="text-gray-800 text-lg sm:text-xl mb-4 font-semibold">${message}</p>
                    <button class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- BART'S SKATEBOARD SCURRY GAME LOGIC (UNCHANGED) ---

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameTimerDisplay = document.getElementById('game-timer');
        const gameOverModal = document.getElementById('game-over-modal');
        const modalTitleText = document.getElementById('modal-title-text');
        const modalBodyText = document.getElementById('modal-body-text');
        const playAgainBtn = document.getElementById('playAgainBtn');

        // Game constants
        const sidewalkHeight = 60;
        const playerWidth = 30;
        const playerHeight = 60;
        const playerDuckHeight = 30;
        const jumpPower = -12;
        const gravity = 0.6;
        const obstacleWidth = 20;
        const groundObstacleHeight = 40; // Hydrant
        const airObstacleHeight = 30; // Branch
        
        // Game state variables
        let player;
        let obstacles;
        let gameSpeed;
        let timer;
        let isDucking;
        let keys;
        let gameInterval;
        // let timerInterval; // This was the duplicate declaration
        let spawnInterval;

        function resizeCanvas() {
            const container = document.getElementById('game-canvas-container');
            // Set canvas size based on its container
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // Initialize player state
        function initPlayer() {
            return {
                x: 50,
                y: canvas.height - sidewalkHeight - playerHeight,
                width: playerWidth,
                height: playerHeight,
                velocityY: 0,
                isGrounded: true
            };
        }

        // Draw the player (Bart)
        function drawPlayer() {
            ctx.fillStyle = '#FFD900'; // Simpsons Yellow
            const currentHeight = isDucking ? playerDuckHeight : player.height;
            const currentY = isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y;
            ctx.fillRect(player.x, currentY, player.width, currentHeight);
        }

        // Draw all obstacles
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.type === 'ground' ? '#E53E3E' : '#8B4513'; // Red (hydrant) or Brown (branch)
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });
        }

        // Update player position (jumping and gravity)
        function updatePlayer() {
            player.velocityY += gravity;
            player.y += player.velocityY;
            player.isGrounded = false;

            // Don't fall through the floor
            const floor = canvas.height - sidewalkHeight - (isDucking ? playerDuckHeight : player.height);
            if (player.y > floor) {
                player.y = floor;
                player.velocityY = 0;
                player.isGrounded = true;
            }
        }

        // Update obstacle positions and check for collisions
        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obstacle = obstacles[i];
                obstacle.x -= gameSpeed;

                // Remove if off-screen
                if (obstacle.x + obstacle.width < 0) {
                    obstacles.splice(i, 1);
                    continue;
                }

                // Collision detection
                const playerRect = {
                    x: player.x,
                    y: isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y,
                    width: player.width,
                    height: isDucking ? playerDuckHeight : player.height
                };

                if (
                    playerRect.x < obstacle.x + obstacle.width &&
                    playerRect.x + playerRect.width > obstacle.x &&
                    playerRect.y < obstacle.y + obstacle.height &&
                    playerRect.y + playerRect.height > obstacle.y
                ) {
                    endGame(false); // Player lost
                    return;
                }
            }
        }

        // Spawn new obstacles
        function spawnObstacle() {
            if (gameInterval) { // Only spawn if game is running
                const type = Math.random() < 0.5 ? 'ground' : 'air';
                let obstacle = {
                    x: canvas.width,
                    width: obstacleWidth,
                    type: type
                };

                if (type === 'ground') {
                    obstacle.y = canvas.height - sidewalkHeight - groundObstacleHeight;
                    obstacle.height = groundObstacleHeight;
                } else { // air
                    obstacle.y = canvas.height - sidewalkHeight - playerHeight - airObstacleHeight; // Positioned for ducking
                    obstacle.height = airObstacleHeight;
                }
                obstacles.push(obstacle);
            }
        }
        
        // Main game loop
        function updateGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear sky
            
            // Draw sidewalk
            ctx.fillStyle = '#a0aec0';
            ctx.fillRect(0, canvas.height - sidewalkHeight, canvas.width, sidewalkHeight);

            updatePlayer();
            drawPlayer();
            updateObstacles();
            drawObstacles();
        }

        // End the game (win or lose)
        function endGame(didWin) {
            clearInterval(gameInterval);
            if (timerInterval) clearInterval(timerInterval); // Check if timerInterval exists before clearing
            clearInterval(spawnInterval);
            gameInterval = null;

            if (didWin) {
                modalTitleText.textContent = "Cowabunga!";
                modalBodyText.textContent = "You survived for 60 seconds! Victory Royale!";
            } else {
                modalTitleText.textContent = "D'oh!";
                modalBodyText.textContent = "You crashed! Try again to get the Victory Royale.";
            }
            gameOverModal.classList.remove('hidden');
        }

        // Start a new game
        function startGame() {
            // Clear any old intervals
            if (gameInterval) clearInterval(gameInterval);
            if (timerInterval) clearInterval(timerInterval);
            if (spawnInterval) clearInterval(spawnInterval);

            resizeCanvas(); // Set canvas size
            
            player = initPlayer();
            obstacles = [];
            gameSpeed = 4;
            timer = 60;
            isDucking = false;
            keys = {};
            gameTimerDisplay.textContent = `TIME: ${timer}`;
            gameOverModal.classList.add('hidden');

            // Start game intervals
            gameInterval = setInterval(updateGame, 1000 / 60); // 60 FPS
            
            // Timer interval
            timerInterval = setInterval(() => {
                timer--;
                gameTimerDisplay.textContent = `TIME: ${timer}`;
                
                // Increase difficulty
                if (timer === 45) {
                    gameSpeed = 5;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1800);
                }
                if (timer === 30) {
                    gameSpeed = 6;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1500);
                }
                if (timer === 15) {
                    gameSpeed = 7;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1200);
                }

                // Win condition
                if (timer <= 0) {
                    endGame(true); // Player won
                }
            }, 1000);

            // Initial obstacle spawn
            spawnInterval = setInterval(spawnObstacle, 2000);
        }

        // Handle keyboard input
        function handleKeyInput(e) {
            if (e.code === 'ArrowUp') {
                e.preventDefault();
                if (player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                if (player.isGrounded) {
                    isDucking = true;
                }
            }
        }
        
        function handleKeyRelease(e) {
             if (e.code === 'ArrowDown') {
                e.preventDefault();
                isDucking = false;
            }
        }
        
        // Handle mobile button input
        function handleTouch(key, isDown) {
             if (key === 'ArrowUp') {
                if (isDown && player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (key === 'ArrowDown') {
                if (isDown && player.isGrounded) {
                    isDucking = true;
                } else {
                    isDucking = false;
                }
            }
        }

        // This function is called when the "Start Game" button is clicked
        function initGame() {
            // Set up event listeners
            document.addEventListener('keydown', handleKeyInput);
            document.addEventListener('keyup', handleKeyRelease);
            
            // Mobile controls
            const upBtn = document.getElementById('up-btn');
            const downBtn = document.getElementById('down-btn');

            // Mouse events
            upBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('mouseup', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });
            downBtn.addEventListener('mouseleave', (e) => { handleTouch('ArrowDown', false); });

            // Touch events
            upBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('touchend', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });

            playAgainBtn.addEventListener('click', startGame);
            
            // Resize canvas once on init, and start the game
            resizeCanvas();
            startGame();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            // Add a resize listener to resize the canvas if the window changes
            window.addEventListener('resize', () => {
                if (gameInterval) {
                    resizeCanvas();
                }
            });
        });
    </script>
</body>

</html>
