<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peanuts: The Snow Tubing Field Trip</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .question-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .question-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question-option.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }

        .question-option.correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .question-option.incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .game-font {
            font-family: 'Bangers', cursive;
        }

        /* --- GAME STYLES --- */
        #game-canvas {
            background: #87CEEB; /* Sky Blue */
            border-bottom: 60px solid #ffffff; /* Snow */
            border-left: 4px solid #3b82f6;
            border-right: 4px solid #3b82f6;
            border-top: 4px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(2, 132, 199, 0.5);
            width: 100%;
            height: 100%;
        }
        
        .control-button {
            @apply bg-gray-700 text-white p-4 rounded-xl text-3xl font-bold transition-transform transform active:scale-95;
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
            width: 80px;
            height: 80px;
        }

        @media (max-width: 1024px) {
            #mobile-controls {
                display: flex !important;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center; /* Corrected 'align: center' */
        }

        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <!-- Navigation Links -->
    <div class="max-w-4xl mx-auto flex justify-between mb-4 text-lg font-semibold">
        <a href="./Math.html" class="text-green-600 hover:text-green-800 underline">
            Go to Math &rarr;
        </a>
        <a href="./Spelling.html" class="text-indigo-600 hover:text-indigo-800 underline">
            Go to Spelling &rarr;
        </a>
    </div>

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 sm:p-10 mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">The Peanuts Gang: Snow Tubing Surprise</h1>
        <p class="text-gray-600 text-center mb-8">A field trip to the snowy hills brings excitement, fear, and friendship.</p>

        <!-- Timer Section -->
        <div id="timer-container" class="bg-gray-100 p-4 rounded-lg text-center mb-6">
            <p class="text-sm font-semibold text-gray-600">Time Elapsed:</p>
            <p id="timer" class="text-2xl font-bold text-blue-600 mt-1">0:00</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container">
            <div id="passage" class="bg-gray-50 rounded-lg p-6 mb-10 text-gray-700 leading-relaxed text-base sm:text-lg border border-gray-200">
                
                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 1: The Announcement</h2>
                <p class="mb-4">It was a Wednesday, usually the most boring day of the week, when Miss Othmar made the announcement. The class sat up straight as her muffled voice *wah-wah-wah'd* over the intercom. Charlie Brown couldn't understand most of it, but he heard the most important words: "Field Trip" and "Snow Tubing."</p>
                <p class="mb-4">"Did you hear that, Charlie Brown?" Linus whispered, clutching his blue blanket. "We're going to the Big Hill at Pinecrest! It's supposed to have the fastest tubes in the state!" Charlie Brown gulped. "Fastest?" he repeated weakly. "I usually have trouble with gravity on flat ground. I'm not sure gravity on a hill is a good idea."</p>
                <p class="mb-4">Lucy leaned over from her desk. "Don't be such a wishy-washy blockhead," she snapped. "It's just sliding. Even you can slide, Charlie Brown. Unless you slide the wrong way and end up in the parking lot." The class giggled. Charlie Brown sighed. "Good grief," he thought. "I'm doomed before I even get on the bus."</p>
                <p class="mb-4">That afternoon, the excitement was electric. Peppermint Patty called from across town. "Chuck! Did you hear? Snow tubing! I'm going to set a world record for speed! Marcie says she's calculating the physics of the slope to ensure maximum velocity." "That's nice, Sir," Marcie's voice chimed in. "But I think I'll just watch from the lodge with a hot chocolate."</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 2: The Bus Ride</h2>
                <p class="mb-4">Friday morning arrived with a crisp, cold wind. The yellow school bus idled by the curb, puffing gray smoke into the winter air. The gang piled on, bundled in so many layers they looked like colorful marshmallows. Sally was wearing a pink snowsuit that was so puffy she couldn't put her arms down. "I feel like a starfish!" she complained.</p>
                <p class="mb-4">Snoopy tried to sneak onto the bus wearing a trench coat and a fedora, pretending to be a "World Famous Bus Driver," but the real driver shooed him away. Unfazed, Snoopy climbed onto the roof of his doghouse, donned his aviator goggles, and prepared to fly his "Sopwith Camel" alongside the bus.</p>
                <p class="mb-4">The ride to Pinecrest took an hour. Linus spent the time explaining the history of vulcanized rubber, which inner tubes are made of. "It's fascinating, really," he said. "Without Charles Goodyear, we wouldn't be sliding anywhere today." Charlie Brown looked out the window at the passing snow-covered trees. He felt a knot in his stomach. What if he fell out? What if he crashed into a tree? What if everyone laughed?</p>
                <p class="mb-4">"Are you worried, Charles?" Marcie asked from the seat behind him. "Probability suggests you will be fine. The tubes are designed for stability." "I defy probability," Charlie Brown muttered. "I have a special relationship with bad luck."</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 3: The Big Hill</h2>
                <p class="mb-4">Pinecrest was huge. The hill looked like a giant white wall stretching up into the sky. Tiny dots—people—were zooming down at incredible speeds, screaming with joy. "Look at that!" Peppermint Patty shouted. "It's magnificent!" She grabbed a tube and ran toward the lift line.</p>
                <p class="mb-4">Charlie Brown stood at the bottom, holding his tube. It was heavy and smelled like old tires. "Well," he said to himself. "Here goes nothing." He trudged up the hill. The line was long, filled with excited chatter. Lucy was already at the top, bossing people around. "You! Move to the left! You! Go faster! Organization is the key to fun!" she yelled.</p>
                <p class="mb-4">When it was finally Charlie Brown's turn, he peered over the edge. It looked steep. Very steep. The attendant hooked his tube to a conveyor belt. "Sit down and hold on," the man said. Charlie Brown sat. He gripped the handles so tight his knuckles turned white through his mittens. "Ready?" the man asked. "No," Charlie Brown whispered.</p>
                <p class="mb-4">*Whoosh!* The attendant gave him a push. Charlie Brown spun backward. "Augh!" he cried. The wind rushed past his ears. The world became a blur of white snow and blue sky. He was spinning faster and faster. He squeezed his eyes shut.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 4: The Crash</h2>
                <p class="mb-4">Suddenly, he felt a bump. Then another. His tube caught air! For a second, Charlie Brown was flying. He opened one eye just in time to see he was drifting out of his lane. He was heading straight for a snowbank on the side. *POOF!*</p>
                <p class="mb-4">Snow exploded everywhere. Charlie Brown landed face-first in a soft, cold drift. His tube rolled away down the hill without him. He lay there for a moment, checking to see if he was still in one piece. He heard laughter. He groaned. "Of course," he thought. "The only kid to crash on a straight track."</p>
                <p class="mb-4">"Are you okay, Charlie Brown?" a voice asked. He looked up. It was the Little Red-Haired Girl. She was holding out a gloved hand. Charlie Brown scrambled up, brushing snow off his face. "I'm fine!" he said, his voice cracking a little. "Just... testing the snow density. It's very... soft." She giggled. "You looked like a snowball," she said kindly. "Do you want to race me next time?"</p>
                <p class="mb-4">Charlie Brown's heart soared higher than his tube had. "Race? Me? You want to race me?" "Sure," she smiled. "It'll be fun." Suddenly, the crash didn't matter. The laughter didn't matter. He had a race to prepare for.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 5: Snoopy to the Rescue</h2>
                <p class="mb-4">Meanwhile, Linus had a problem. His blanket had gotten snagged on a tree branch near the top of the hill. "My security!" he wailed. "I can't go down without it!" He tried to jump for it, but it was too high. The line was holding up. "Move it!" kids yelled.</p>
                <p class="mb-4">Suddenly, a white blur streaked across the sky. It was Snoopy! He was using his ears like helicopter blades. He swooped down, grabbed the blanket in his teeth, and landed gracefully next to Linus. He wrapped the blanket around Linus's neck like a scarf and gave him a thumbs-up (or a paws-up).</p>
                <p class="mb-4">"Thank you, Snoopy!" Linus cheered. "You're a lifesaver!" Snoopy bowed, then jumped into a spare tube. He lay on his stomach, headfirst, ears streaming behind him. He zoomed down the hill, passing Peppermint Patty. "Hey!" she shouted. "That strange kid with the big nose is passing me!" Snoopy crossed the finish line first, spun in a circle, and did a happy dance.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 6: Hot Chocolate and Heroes</h2>
                <p class="mb-4">The sun began to set, painting the snow in shades of pink and orange. The gang gathered in the lodge. Everyone was tired, wet, and happy. They held mugs of steaming hot chocolate with marshmallows. Even Pig-Pen looked clean, the snow having washed away his usual dust cloud.</p>
                <p class="mb-4">"That was actually... fun," Charlie Brown admitted, sipping his cocoa. He had raced the Little Red-Haired Girl three times. He lost every time, but she had waited for him at the bottom each run. "See?" Lucy said, stealing a marshmallow from his cup. "I told you. You just need someone to tell you what to do."</p>
                <p class="mb-4">"I think," Linus said, warming his hands, "that the thrill of the descent is only matched by the comfort of the return. Gravity is a harsh mistress, but a fair one." "You talk funny, sweet babboo," Sally sighed, gazing at him.</p>
                <p class="mb-4">Charlie Brown looked around at his friends. Snoopy was asleep by the fireplace, his stomach full of pizza crusts he had scavenged. The fear of the hill was gone, replaced by the warmth of the fire and friendship. He realized that even if he crashed, even if he spun backward, the important thing was getting back up and getting back in line. "Same time next year?" Franklin asked. Charlie Brown smiled, a real, big smile. "You bet."</p>

            </div>

            <div id="questions-container" class="space-y-10">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </div>

            <div class="mt-10 text-center space-x-4">
                <button id="submitBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-600 transition duration-300 shadow-lg">
                    Check Answers
                </button>
            </div>
        </div>

        <div id="results" class="mt-8 p-6 rounded-lg text-center font-bold text-lg hidden">
            <p id="scoreText"></p>
            <div class="mt-4 space-x-4">
                <button id="startGameBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 shadow-md hidden">
                    Congratulations! Play Snoopy's Word Catcher!
                </button>
                <button id="retakeQuizBtn" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300 shadow-md hidden">
                    Retake Quiz
                </button>
            </div>
        </div>

        <hr class="my-12 border-gray-300">

        <!-- --- GAME SECTION: Snoopy's Word Catcher --- -->
        <div id="game-container" class="flex flex-col items-center justify-center min-h-[500px] p-4 bg-gray-100 rounded-lg shadow-inner" style="display: none;">
            
            <div id="game-info" class="mb-4 w-full max-w-xl text-center text-gray-800 bg-white p-4 rounded-xl border-2 border-blue-400">
                <h1 class="text-3xl font-bold mb-2 header-font text-blue-700">Snoopy's Word Catcher!</h1>
                <p class="text-gray-600">Catch 10 <span class="text-green-600 font-bold">GOOD</span> words (fun, brave, kind) to win! Avoid the <span class="text-red-600 font-bold">BAD</span> words (fear, crash, sad)!</p>
            </div>

            <!-- Game Stats -->
            <div class="flex justify-between w-full max-w-xl mb-2 px-4 text-gray-800 game-font text-2xl">
                <div id="score-display">WORDS: 0/10</div>
                <div id="timer-display">TIME: 60</div>
            </div>

            <!-- Game Canvas -->
            <div id="game-canvas-container" class="relative w-full max-w-xl aspect-[4/3] overflow-hidden rounded-lg">
                 <canvas id="game-canvas"></canvas>
            </div>

            <!-- Mobile Controls -->
            <div id="mobile-controls" class="hidden flex justify-center space-x-12 w-full mt-6">
                <button id="left-btn" class="control-button">◄</button>
                <button id="right-btn" class="control-button">►</button>
            </div>

            <!-- Game Over Modal -->
            <div id="game-over-modal" class="modal-overlay hidden">
                 <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <h2 id="modal-title-text" class="text-3xl font-bold mb-4 text-yellow-700 header-font">Good Grief!</h2>
                    <p id="modal-body-text" class="text-gray-800 text-lg mb-6">Game Over!</p>
                    <button id="playAgainBtn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- NEW QUIZ DATA (Based on Snow Tubing Story) ---
        const allQuestions = [
            {
                id: 'q1',
                questionText: "What was the exciting announcement Miss Othmar made?",
                options: [
                    { value: 'A', text: 'Extra homework for everyone.' },
                    { value: 'B', text: 'A field trip to go Snow Tubing.' },
                    { value: 'C', text: 'School was cancelled forever.' },
                    { value: 'D', text: 'A pop quiz in math.' }
                ],
                type: 'radio'
            },
            {
                id: 'q2',
                questionText: "What was Charlie Brown worried about regarding the hill?",
                options: [
                    { value: 'A', text: 'He was worried about gravity and falling.' },
                    { value: 'B', text: 'He forgot his mittens.' },
                    { value: 'C', text: 'He didn\'t want to miss lunch.' },
                    { value: 'D', text: 'He was afraid of snowmen.' }
                ],
                type: 'radio'
            },
            {
                id: 'q3',
                questionText: "How did Snoopy get to the field trip?",
                options: [
                    { value: 'A', text: 'He hid under a seat on the bus.' },
                    { value: 'B', text: 'He flew his doghouse like a Sopwith Camel.' },
                    { value: 'C', text: 'He ran very fast.' },
                    { value: 'D', text: 'He took a taxi.' }
                ],
                type: 'radio'
            },
            {
                id: 'q4',
                questionText: "What happened to Charlie Brown on his first run down the hill?",
                options: [
                    { value: 'A', text: 'He set a world speed record.' },
                    { value: 'B', text: 'He stayed perfectly in his lane.' },
                    { value: 'C', text: 'He spun backwards and crashed into a snowbank.' },
                    { value: 'D', text: 'He fell asleep.' }
                ],
                type: 'radio'
            },
            {
                id: 'q5',
                questionText: "Who helped Charlie Brown up after he crashed?",
                options: [
                    { value: 'A', text: 'Lucy.' },
                    { value: 'B', text: 'Peppermint Patty.' },
                    { value: 'C', text: 'The Little Red-Haired Girl.' },
                    { value: 'D', text: 'Linus.' }
                ],
                type: 'radio'
            },
            {
                id: 'q6',
                questionText: "Why was Linus stuck at the top of the hill?",
                options: [
                    { value: 'A', text: 'He was too scared to move.' },
                    { value: 'B', text: 'His blanket got snagged on a tree branch.' },
                    { value: 'C', text: 'He lost his tube.' },
                    { value: 'D', text: 'He was waiting for the Great Pumpkin.' }
                ],
                type: 'radio'
            },
            {
                id: 'q7',
                questionText: "How did Snoopy help Linus?",
                options: [
                    { value: 'A', text: 'He dug a tunnel.' },
                    { value: 'B', text: 'He flew down and grabbed the blanket with his teeth.' },
                    { value: 'C', text: 'He barked for help.' },
                    { value: 'D', text: 'He brought him a ladder.' }
                ],
                type: 'radio'
            },
            {
                id: 'q8',
                questionText: "What did the kids drink in the lodge after tubing?",
                options: [
                    { value: 'A', text: 'Ice water.' },
                    { value: 'B', text: 'Lemonade.' },
                    { value: 'C', text: 'Hot chocolate with marshmallows.' },
                    { value: 'D', text: 'Orange juice.' }
                ],
                type: 'radio'
            },
            {
                id: 'q9',
                questionText: "What did Charlie Brown realize at the end of the day?",
                options: [
                    { value: 'A', text: 'He hates snow.' },
                    { value: 'B', text: 'He never wants to go on a field trip again.' },
                    { value: 'C', text: 'Even if he crashed, getting back up and trying again was worth it.' },
                    { value: 'D', text: 'Lucy is always right.' }
                ],
                type: 'radio'
            },
            {
                id: 'q10',
                questionText: "Who won the race down the hill against Peppermint Patty?",
                options: [
                    { value: 'A', text: 'Marcie.' },
                    { value: 'B', text: 'Franklin.' },
                    { value: 'C', text: 'Snoopy (the strange kid with the big nose).' },
                    { value: 'D', text: 'Pig-Pen.' }
                ],
                type: 'radio'
            }
        ];

        // --- NEW Correct Answers ---
        const correctAnswers = {
            q1: "B",
            q2: "A",
            q3: "B",
            q4: "C",
            q5: "C",
            q6: "B",
            q7: "B",
            q8: "C",
            q9: "C",
            q10: "C"
        };


        // --- ALL SCRIPTING BELOW THIS LINE IS UNCHANGED ---

        // DOM elements
        const submitBtn = document.getElementById('submitBtn');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('scoreText');
        const questionsContainer = document.getElementById('questions-container');
        const quizContainer = document.getElementById('quiz-container');
        const gameContainer = document.getElementById('game-container');
        const timerDisplay = document.getElementById('timer');

        // Quiz State
        let startTime;
        let timerInterval;

        // Function to shuffle an array in place (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Timer functions
        function updateTimerDisplay() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = Date.now();
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Renders the quiz questions to the page
        function renderQuiz() {
            questionsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            retakeQuizBtn.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            gameContainer.style.display = 'none';
            quizContainer.style.display = 'block';

            const optionLabels = ['A', 'B', 'C', 'D'];
            const shuffledQuestions = shuffleArray([...allQuestions]);

            shuffledQuestions.forEach((q, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = q.id;
                questionDiv.className = 'question p-6 rounded-lg shadow-md bg-white border border-gray-200';

                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-lg mb-4';
                questionText.innerHTML = `${questionIndex + 1}. ${q.questionText}`;
                questionDiv.appendChild(questionText);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-4 text-sm sm:text-base';
                questionDiv.appendChild(optionsDiv);

                const shuffledOptions = shuffleArray([...q.options]);
                shuffledOptions.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'question-option block bg-gray-50 p-4 rounded-lg border border-gray-200';
                    const input = document.createElement('input');
                    input.type = q.type;
                    input.name = q.id;
                    input.value = option.value;
                    input.className = 'mr-3';

                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${optionLabels[index]}. ${option.text}`));

                    label.addEventListener('click', () => {
                        if (input.type === 'radio') {
                            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                                radio.parentElement.classList.remove('selected');
                            });
                            label.classList.add('selected');
                        }
                    });
                    optionsDiv.appendChild(label);
                });
                questionsContainer.appendChild(questionDiv);
            });
            startTimer();
        }

        // Event Listeners for quiz
        submitBtn.addEventListener('click', () => {
            let score = 0;
            let totalQuestions = 0;
            let allAnswered = true;

            document.querySelectorAll('.question-option').forEach(label => {
                label.classList.remove('selected', 'correct-answer', 'incorrect-answer');
            });

            questionsContainer.querySelectorAll('.question').forEach(question => {
                const questionId = question.id;
                const labels = question.querySelectorAll('.question-option');
                const selected = question.querySelector('input[type="radio"]:checked');
                const correctAnswerValue = correctAnswers[questionId];

                if (!selected) {
                    allAnswered = false;
                    return;
                }

                totalQuestions++;
                labels.forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === correctAnswerValue) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selected && selected.value === correctAnswerValue) {
                    score++;
                } else if (selected) {
                    selected.parentElement.classList.add('incorrect-answer');
                }
            });

            if (!allAnswered) {
                showBasicMessage("Please answer all questions before submitting.");
                return;
            }

            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%).`;
            resultsDiv.classList.remove('hidden');
            retakeQuizBtn.classList.remove('hidden');

            if (score === totalQuestions) {
                stopTimer(); // Stop the timer on a perfect score
                const finalTime = timerDisplay.textContent;
                scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%). You completed the quiz in ${finalTime}.`;
                resultsDiv.classList.add('bg-green-100', 'text-green-700');
                resultsDiv.classList.remove('bg-red-100', 'text-red-700');
                startGameBtn.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('bg-red-100', 'text-red-700');
                resultsDiv.classList.remove('bg-green-100', 'text-green-700');
            }
        });

        retakeQuizBtn.addEventListener('click', () => {
            renderQuiz();
        });

        startGameBtn.addEventListener('click', () => {
            quizContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            startGame();
        });

        // Simple message box to replace alert()
        function showBasicMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'modal-overlay';
            messageBox.innerHTML = `
                <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <p class="text-gray-800 text-lg sm:text-xl mb-4 font-semibold">${message}</p>
                    <button class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- SNOOPY'S WORD CATCHER GAME LOGIC ---

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const gameTimerDisplay = document.getElementById('timer-display');
        const gameOverModal = document.getElementById('game-over-modal');
        const modalTitleText = document.getElementById('modal-title-text');
        const modalBodyText = document.getElementById('modal-body-text');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');

        // Game constants
        const playerWidth = 60;
        const playerHeight = 60;
        const gravity = 0; // Not a jumping game
        const wordSpeed = 3;
        
        // Words data - Updated to be generic "good" and "bad" for flexibility, or could be snow themed
        const goodWords = ["FUN", "SLIDE", "FAST", "SNOW", "LAUGH", "FRIEND", "PLAY", "SAFE"];
        const badWords = ["CRASH", "SAD", "HURT", "COLD", "FEAR", "OUCH", "STOP", "LOST"];

        // Game state variables
        let playerX;
        let playerY;
        let fallingWords = [];
        let score = 0;
        let timeLeft = 60;
        let gameLoop;
        let spawnInterval;
        let gameTimerInterval;
        let isMovingLeft = false;
        let isMovingRight = false;

        function resizeCanvas() {
            const container = document.getElementById('game-canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            playerY = canvas.height - playerHeight - 10;
        }

        // Initialize player position
        function initPlayer() {
            playerX = canvas.width / 2 - playerWidth / 2;
        }

        // Draw Snoopy (simplified as a white box with black ears for now, or text)
        function drawPlayer() {
            // Draw Snoopy-like shape
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.ellipse(playerX + playerWidth/2, playerY + playerHeight/2, playerWidth/2, playerHeight/3, 0, 0, Math.PI * 2);
            ctx.fill();
            // Ear
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.ellipse(playerX + 20, playerY + playerHeight/2, 10, 15, 0, 0, Math.PI * 2);
            ctx.fill();
            // Nose
            ctx.beginPath();
            ctx.ellipse(playerX + playerWidth - 10, playerY + playerHeight/2 - 5, 5, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            // Scarf (Red for winter theme)
            ctx.fillStyle = "red";
            ctx.fillRect(playerX + playerWidth/2 - 5, playerY + playerHeight/2 + 10, 20, 8);
        }

        // Spawn a new word
        function spawnWord() {
            const isGood = Math.random() > 0.4; // 60% chance of good word
            const text = isGood ? goodWords[Math.floor(Math.random() * goodWords.length)] : badWords[Math.floor(Math.random() * badWords.length)];
            const x = Math.random() * (canvas.width - 100);
            
            fallingWords.push({
                x: x,
                y: -30,
                text: text,
                isGood: isGood,
                width: ctx.measureText(text).width + 20
            });
        }

        // Update and draw words
        function updateAndDrawWords() {
            ctx.font = "bold 20px 'Inter'";
            
            for (let i = fallingWords.length - 1; i >= 0; i--) {
                let word = fallingWords[i];
                word.y += wordSpeed;

                // Draw word background
                ctx.fillStyle = word.isGood ? "#dcfce7" : "#fee2e2";
                ctx.strokeStyle = word.isGood ? "#16a34a" : "#dc2626";
                ctx.lineWidth = 2;
                
                const textWidth = ctx.measureText(word.text).width;
                const boxWidth = textWidth + 20;
                const boxHeight = 30;
                
                ctx.fillRect(word.x, word.y - 20, boxWidth, boxHeight);
                ctx.strokeRect(word.x, word.y - 20, boxWidth, boxHeight);

                // Draw text
                ctx.fillStyle = word.isGood ? "#166534" : "#991b1b";
                ctx.fillText(word.text, word.x + 10, word.y);

                // Collision detection
                if (
                    playerX < word.x + boxWidth &&
                    playerX + playerWidth > word.x &&
                    playerY < word.y + boxHeight &&
                    playerY + playerHeight > word.y - 20
                ) {
                    // Collision!
                    if (word.isGood) {
                        score += 1;
                        scoreDisplay.textContent = `WORDS: ${score}/10`;
                        if (score >= 10) {
                            endGame(true); // Win
                        }
                    } else {
                        endGame(false); // Lose
                    }
                    fallingWords.splice(i, 1); // Remove word
                    continue;
                }

                // Remove if off screen
                if (word.y > canvas.height) {
                    fallingWords.splice(i, 1);
                }
            }
        }

        // Main game loop
        function updateGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear sky
            
            // Draw snow ground
            ctx.fillStyle = '#f0f9ff';
            ctx.fillRect(0, canvas.height - 60, canvas.width, 60);

            // Move player
            if (isMovingLeft && playerX > 0) playerX -= 5;
            if (isMovingRight && playerX < canvas.width - playerWidth) playerX += 5;

            drawPlayer();
            updateAndDrawWords();
        }

        // End the game
        function endGame(didWin) {
            clearInterval(gameLoop);
            clearInterval(spawnInterval);
            clearInterval(gameTimerInterval);
            
            if (didWin) {
                modalTitleText.textContent = "You Won!";
                modalBodyText.textContent = "Great job catching all the good words!";
            } else {
                modalTitleText.textContent = "Good Grief!";
                modalBodyText.textContent = `You caught a bad word! Keep trying!`;
            }
            gameOverModal.classList.remove('hidden');
        }

        // Start a new game
        function startGame() {
            // Reset state
            if (gameLoop) clearInterval(gameLoop);
            if (spawnInterval) clearInterval(spawnInterval);
            if (gameTimerInterval) clearInterval(gameTimerInterval);

            resizeCanvas();
            initPlayer();
            fallingWords = [];
            score = 0;
            timeLeft = 60;
            
            scoreDisplay.textContent = `WORDS: 0/10`;
            gameTimerDisplay.textContent = `TIME: 60`;
            gameOverModal.classList.add('hidden');

            // Start intervals
            gameLoop = setInterval(updateGame, 1000 / 60); // 60 FPS
            spawnInterval = setInterval(spawnWord, 1500); // New word every 1.5s
            
            gameTimerInterval = setInterval(() => {
                timeLeft--;
                gameTimerDisplay.textContent = `TIME: ${timeLeft}`;
                if (timeLeft <= 0) {
                    endGame(false); // Lose due to time
                }
            }, 1000);
        }

        // Handle keyboard input
        document.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowLeft') isMovingLeft = true;
            if (e.code === 'ArrowRight') isMovingRight = true;
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowLeft') isMovingLeft = false;
            if (e.code === 'ArrowRight') isMovingRight = false;
        });
        
        // Handle mobile button input
        leftBtn.addEventListener('mousedown', () => isMovingLeft = true);
        leftBtn.addEventListener('mouseup', () => isMovingLeft = false);
        leftBtn.addEventListener('touchstart', (e) => { e.preventDefault(); isMovingLeft = true; });
        leftBtn.addEventListener('touchend', (e) => { e.preventDefault(); isMovingLeft = false; });

        rightBtn.addEventListener('mousedown', () => isMovingRight = true);
        rightBtn.addEventListener('mouseup', () => isMovingRight = false);
        rightBtn.addEventListener('touchstart', (e) => { e.preventDefault(); isMovingRight = true; });
        rightBtn.addEventListener('touchend', (e) => { e.preventDefault(); isMovingRight = false; });

        playAgainBtn.addEventListener('click', startGame);

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            window.addEventListener('resize', () => {
                if (gameLoop) {
                    resizeCanvas();
                    initPlayer(); // Recenter player on resize just in case
                }
            });
        });
    </script>
</body>

</html>
