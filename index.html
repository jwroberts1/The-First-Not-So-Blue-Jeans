<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Simpsons in Fortnite Quiz</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .question-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .question-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question-option.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }

        .question-option.correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .question-option.incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .game-font {
            font-family: 'Bangers', cursive;
        }

        /* --- NEW GAME STYLES --- */
        #game-canvas {
            background: #87CEEB; /* Sky Blue */
            border-bottom: 60px solid #a0aec0; /* Sidewalk */
            border-left: 4px solid #3b82f6;
            border-right: 4px solid #3b82f6;
            border-top: 4px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(2, 132, 199, 0.5);
            width: 100%;
            height: 100%;
        }
        
        .control-button {
            @apply bg-gray-700 text-white p-4 rounded-xl text-3xl font-bold transition-transform transform active:scale-95;
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
            width: 80px;
            height: 80px;
        }

        @media (max-width: 1024px) {
            #mobile-controls {
                display: flex !important;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center; /* Corrected 'align: center' */
        }

        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <!-- Navigation Links -->
    <div class="max-w-4xl mx-auto flex justify-between mb-4 text-lg font-semibold">
        <a href="./Math.html" class="text-green-600 hover:text-green-800 underline">
            Go to Math &rarr;
        </a>
        <a href="./Spelling.html" class="text-indigo-600 hover:text-indigo-800 underline">
            Go to Spelling &rarr;
        </a>
    </div>

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 sm:p-10 mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">Zero Hour: The Clash of Legends</h1>
        <p class="text-gray-600 text-center mb-8">Read the story below. Then answer the questions to test your reading comprehension!</p>

        <!-- Timer Section -->
        <div id="timer-container" class="bg-gray-100 p-4 rounded-lg text-center mb-6">
            <p class="text-sm font-semibold text-gray-600">Time Elapsed:</p>
            <p id="timer" class="text-2xl font-bold text-blue-600 mt-1">0:00</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container">
            <div id="passage" class="bg-gray-50 rounded-lg p-6 mb-10 text-gray-700 leading-relaxed text-base sm:text-lg border border-gray-200">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 1: The Sky Turns Purple</h2>

                <p class="mb-4">Homer Simpson sat on the roof of the Durrr Burger restaurant, his legs dangling over the edge. He was trying to enjoy a "Victory Royale" sandwich, but it was hard to eat when the sky looked like a giant, angry bruise. For weeks, the island had been acting strange. Gravity would turn off for five seconds, making everyone float like balloons. Loot chests would sometimes contain nothing but coal. And now, a massive shadow was creeping across the sun.</p>
                <p class="mb-4">"Dad!" called Lisa, who was standing on the ground below with her high-tech binoculars. "The energy readings are spiking again! The Dark Presence isn't just watching us anymore. It’s descending!"</p>
                <p class="mb-4">"Can't it wait until I finish my lunch?" Homer grumbled, taking a bite. "I haven't even had my dessert donut yet."</p>
                <p class="mb-6">"No, Homer," Marge said, her voice trembling as she tightened the straps on her back bling (which was Maggie in a specialized carrier). "Look at the horizon. The storm isn't shrinking... it's breaking."</p>

                <p class="mb-4">Marge was right. The usual purple storm wall that forced players together wasn't moving. Instead, the sky itself seemed to crack like a dropped egg. Shards of blue digital glass fell away, revealing a swirling vortex of darkness. This was the "Dark Presence," a cosmic enemy that wanted to delete the entire island file forever.</p>
                <p class="mb-6">"Ay, Caramba!" Bart yelled, zooming past them on a hoverboard. "It's 'Zero Hour'! The live event is starting! Everyone get to the safe zone!"</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 2: Portals Open Wide</h2>

                <p class="mb-4">The darkness began to shoot lightning bolts at the Tilted Towers clock tower. *CRASH!* The clock face exploded. But just when it seemed like all hope was lost, the universe fought back. Golden circles—portals—began to spin open all over the sky. It looked like a fireworks show made of pure magic.</p>
                <p class="mb-4">"Who's coming to save us?" asked Milhouse, who was hiding behind a bush wearing a Fishstick costume.</p>
                <p class="mb-4">"Everyone," Lisa whispered in awe. "Absolutely everyone."</p>

                <p class="mb-4">From the first portal flew a streak of red and gold. It was Iron Man, his repulsor beams blasting the dark clouds away. "Jarvis, target the main core!" he shouted, his voice echoing over the island. From another portal, a man in a blue suit with a red cape soared down. Superman’s eyes glowed red as he used his heat vision to melt the shadow monsters that were spawning on the ground.</p>
                <p class="mb-6">But the biggest surprise came from the ocean. The water bubbled and boiled. A roar, loud enough to shake the controller in your hands, erupted from the depths. Godzilla, the King of the Monsters, rose from the sea! His dorsal fins glowed neon blue as he charged up his atomic breath. And leaping from the mountains to join him was King Kong, beating his chest like a giant drum.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 3: The Ultimate Crossover</h2>

                <p class="mb-4">"This is the coolest thing I have ever seen!" Bart screamed, snapping pictures. "It’s like my toy box exploded!"</p>
                <p class="mb-4">The battle was chaos. On one side, you had the Dark Presence, sending down ships that looked like sharp triangles—Star Destroyers. On the other side, you had the heroes. A group of Demon Hunters, dressed in stylish black coats, dashed through the streets with glowing swords, slicing through shadow creatures. And sitting right on top of Godzilla’s head, singing a song that sounded like sparkling digital rain, was Hatsune Miku. Her blue pigtails waved in the wind as she amplified the heroes' morale with her music.</p>
                
                <p class="mb-4">Homer, however, was confused. "Wait, is that the guy from the rapping game? And why is Batman fighting a banana?"</p>
                <p class="mb-4">"Focus, Dad!" Lisa yelled. She pulled out a tablet. "The Dark Presence is too strong. Godzilla’s breath isn't hurting it enough. Iron Man’s lasers are bouncing off. We need something else. Something from the island’s own history."</p>

                <p class="mb-6">The Dark Presence let out a screech that shattered windows. It grew larger, wrapping its smoky fingers around the entire map. The health bars of the heroes were dropping. King Kong was knocked back into the jungle. Iron Man’s suit was sparking. It looked like 'Game Over' was about to flash on the screen.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 4: The Return of Kevin</h2>

                <p class="mb-4">Suddenly, the ground beneath Loot Lake began to glow purple. A familiar, deep humming sound vibrated through everyone's chests. *Vmmmmmm-THRUM.*</p>
                <p class="mb-4">"I know that sound," Jonesy said. He was standing near the Simpsons, holding a Rift Device. "It's our last hope."</p>
                <p class="mb-4">The ground cracked open, and a massive, glowing purple cube rose into the air. It spun slowly, crackling with lightning.</p>
                <p class="mb-4">"Kevin!" Bart cheered. "Kevin the Cube is back!"</p>

                <p class="mb-4">For years, the Cube (nicknamed Kevin by the fans) had been a mystery. Sometimes he crushed players; sometimes he made them bounce. But today, he was a weapon. Jonesy aimed his device at the Dark Presence. "All units," Jonesy shouted into his radio. "Clear the way for the Cube!"</p>
                <p class="mb-6">Godzilla roared and grabbed the Dark Presence's arms. Iron Man and Superman flew together, creating a whirlwind to hold the shadow in place. Then, the Cube began to spin faster and faster until it was a purple blur. With a sonic boom, it launched itself like a cannonball straight into the heart of the Dark Presence.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 5: The Big Reset</h2>

                <p class="mb-4">The collision was silent at first. Then, a blinding white light swallowed everything. The Dark Presence shattered like glass. The Cube exploded into a million purple sparkles, sacrificing itself to save the island.</p>
                <p class="mb-4">"He did it," Marge whispered, shielding her eyes. "The brave little geometry shape saved us."</p>
                
                <p class="mb-4">But the explosion was too powerful. The reality of the island began to destabilize. The trees turned into code. The buildings began to float. "The file is corrupting!" Lisa warned. "We're loading into a new chapter! Hold onto something!"</p>
                <p class="mb-4">"I'm holding onto my donut!" Homer yelled.</p>
                <p class="mb-6">The world went black. Darkness. Silence. For a moment, it seemed like the game had crashed.</p>

                <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-700">Chapter 6: Pacific Break</h2>

                <p class="mb-4">Slowly, the sound of seagulls faded in. The warmth of the sun hit their faces. Homer opened one eye, then the other. He wasn't on a roof anymore. He was sitting in a beach chair, burying his toes in warm sand.</p>
                <p class="mb-4">"Ooh," Homer said. "Is this heaven? It smells like coconut sunscreen."</p>
                <p class="mb-4">"No, Dad," Lisa said, looking at a map on a nearby sign. "Welcome to Chapter 7: Pacific Break."</p>

                <p class="mb-4">They looked around. The old island was gone. In its place was a beautiful, sunny paradise. To the north, there were giant movie studios with the sign "HOLLYWOOD." To the east, there was a mysterious fenced-off desert that looked like Area 51. And flying through the sky weren't just buses, but players in wingsuits, gliding like squirrels.</p>
                <p class="mb-4">"Look!" Bart pointed. A van pulled up—a Reboot Van—but nobody was respawning. A player was actually driving it down the road. "Drivable Reboot Vans! Finally!"</p>
                
                <p class="mb-4">"This is nice," Marge said, relaxing. "No monsters. No shadows. Just a nice vacation."</p>
                <p class="mb-6">But just as she said that, a massive shadow fell over the beach. A giant UFO, the Mothership of the Last Reality, descended from the clouds. It fired a green laser beam and blew up the Battle Bus. *BOOM!*</p>
                
                <p class="mb-4">Homer sighed and stood up. "Well," he said, dusting the sand off his pants. "Vacation's over. Lisa, hand me that pickaxe. Bart, grab your slingshot. It looks like we have some aliens to fight."</p>
                <p class="mb-4">"You got it, Dad!" Bart said.</p>
                <p class="mb-4">The Simpsons ran toward the new adventure, ready for whatever Chapter 7 had in store.</p>
            </div>

            <div id="questions-container" class="space-y-10">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </div>

            <div class="mt-10 text-center space-x-4">
                <button id="submitBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-600 transition duration-300 shadow-lg">
                    Check Answers
                </button>
            </div>
        </div>

        <div id="results" class="mt-8 p-6 rounded-lg text-center font-bold text-lg hidden">
            <p id="scoreText"></p>
            <div class="mt-4 space-x-4">
                <button id="startGameBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 shadow-md hidden">
                    Congratulations! Play the New Game!
                </button>
                <button id="retakeQuizBtn" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300 shadow-md hidden">
                    Retake Quiz
                </button>
            </div>
        </div>

        <hr class="my-12 border-gray-300">

        <!-- --- NEW GAME SECTION: Bart's Skateboard Scurry --- -->
        <div id="game-container" class="flex flex-col items-center justify-center min-h-[500px] p-4 bg-gray-100 rounded-lg shadow-inner" style="display: none;">
            
            <div id="game-info" class="mb-4 w-full max-w-xl text-center text-gray-800 bg-white p-4 rounded-xl border-2 border-blue-400">
                <h1 class="text-3xl font-bold mb-2 header-font text-blue-700">Bart's Skateboard Scurry!</h1>
                <p class="text-gray-600">Survive for 60 seconds! Use arrows or buttons to JUMP (▲) and DUCK (▼).</p>
            </div>

            <!-- Game Timer -->
            <div id="game-timer" class="text-4xl font-bold game-font text-yellow-500 mb-4 bg-gray-800 px-4 py-1 rounded-lg border-2 border-yellow-400">
                TIME: 60
            </div>

            <!-- Game Canvas -->
            <div id="game-canvas-container" class="relative w-full max-w-xl aspect-[4/3] overflow-hidden rounded-lg">
                 <canvas id="game-canvas"></canvas>
            </div>

            <!-- Mobile Controls -->
            <div id="mobile-controls" class="hidden flex justify-center space-x-12 w-full mt-6">
                <button id="up-btn" class="control-button">▲</button>
                <button id="down-btn" class="control-button">▼</button>
            </div>

            <!-- Game Over Modal (Replaces old win message) -->
            <div id="game-over-modal" class="modal-overlay hidden">
                 <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <h2 id="modal-title-text" class="text-3xl font-bold mb-4 text-yellow-700 header-font">You Win!</h2>
                    <p id="modal-body-text" class="text-gray-800 text-lg mb-6">Cowabunga! You survived for 60 seconds!</p>
                    <button id="playAgainBtn" class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- NEW QUIZ DATA (Based on Zero Hour Story) ---
        const allQuestions = [
            {
                id: 'q1',
                questionText: "What was the name of the 'cosmic enemy' that appeared in Chapter 1?",
                options: [
                    { value: 'A', text: 'The Purple Storm' },
                    { value: 'B', text: 'The Dark Presence' },
                    { value: 'C', text: 'The Llama Lord' },
                    { value: 'D', text: 'The Star Destroyer' }
                ],
                type: 'radio'
            },
            {
                id: 'q2',
                questionText: "Which three heroes/creatures appeared to fight the darkness first?",
                options: [
                    { value: 'A', text: 'Batman, Robin, and Joker' },
                    { value: 'B', text: 'Homer, Marge, and Lisa' },
                    { value: 'C', text: 'Iron Man, Superman, and Godzilla' },
                    { value: 'D', text: 'Peely, Fishstick, and Jonesy' }
                ],
                type: 'radio'
            },
            {
                id: 'q3',
                questionText: "What was Hatsune Miku doing during the battle?",
                options: [
                    { value: 'A', text: 'Singing on top of Godzilla\'s head' },
                    { value: 'B', text: 'Flying a spaceship' },
                    { value: 'C', text: 'Eating a victory sandwich' },
                    { value: 'D', text: 'Hiding in a bunker' }
                ],
                type: 'radio'
            },
            {
                id: 'q4',
                questionText: "Read the sentence: 'It looked like a fireworks show made of pure magic.' What is the author describing?",
                options: [
                    { value: 'A', text: 'The explosion of the Battle Bus' },
                    { value: 'B', text: 'Iron Man\'s laser beams' },
                    { value: 'C', text: 'The golden portals opening in the sky' },
                    { value: 'D', text: 'Lisa\'s high-tech scanner' }
                ],
                type: 'radio'
            },
            {
                id: 'q5',
                questionText: "Who is 'Kevin'?",
                options: [
                    { value: 'A', text: 'A player driving the Reboot Van' },
                    { value: 'B', text: 'The name of the giant purple Cube' },
                    { value: 'C', text: 'The pilot of the Star Destroyer' },
                    { value: 'D', text: 'Bart\'s pet fish' }
                ],
                type: 'radio'
            },
            {
                id: 'q6',
                questionText: "How did the heroes finally defeat the Dark Presence?",
                options: [
                    { value: 'A', text: 'Godzilla ate it.' },
                    { value: 'B', text: 'Iron Man shot it with a unibeam.' },
                    { value: 'C', text: 'The Cube launched itself into the center and exploded.' },
                    { value: 'D', text: 'Homer offered it a donut.' }
                ],
                type: 'radio'
            },
            {
                id: 'q7',
                questionText: "What is the name of the new location in Chapter 7?",
                options: [
                    { value: 'A', text: 'Pacific Break' },
                    { value: 'B', text: 'Tilted Towers' },
                    { value: 'C', text: 'Loot Lake' },
                    { value: 'D', text: 'Tomato Town' }
                ],
                type: 'radio'
            },
            {
                id: 'q8',
                questionText: "What new feature did Bart get excited about in Chapter 7?",
                options: [
                    { value: 'A', text: 'Flying dogs' },
                    { value: 'B', text: 'Drivable Reboot Vans' },
                    { value: 'C', text: 'Invisible cars' },
                    { value: 'D', text: 'Underground tunnels' }
                ],
                type: 'radio'
            },
            {
                id: 'q9',
                questionText: "What happened to the Battle Bus at the very end of the story?",
                options: [
                    { value: 'A', text: 'It landed safely on the beach.' },
                    { value: 'B', text: 'It turned into a submarine.' },
                    { value: 'C', text: 'It flew into space.' },
                    { value: 'D', text: 'It was blown up by a UFO laser.' }
                ],
                type: 'radio'
            },
            {
                id: 'q10',
                questionText: "Which of these best describes Homer Simpson's attitude in the story?",
                options: [
                    { value: 'A', text: 'Serious and focused' },
                    { value: 'B', text: 'Scared and hiding' },
                    { value: 'C', text: 'Relaxed and hungry, but ready to help when needed' },
                    { value: 'D', text: 'Angry and mean' }
                ],
                type: 'radio'
            }
        ];

        // --- NEW Correct Answers ---
        const correctAnswers = {
            q1: "B",
            q2: "C",
            q3: "A",
            q4: "C",
            q5: "B",
            q6: "C",
            q7: "A",
            q8: "B",
            q9: "D",
            q10: "C"
        };


        // --- ALL SCRIPTING BELOW THIS LINE IS UNCHANGED ---

        // DOM elements
        const submitBtn = document.getElementById('submitBtn');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('scoreText');
        const questionsContainer = document.getElementById('questions-container');
        const quizContainer = document.getElementById('quiz-container');
        const gameContainer = document.getElementById('game-container');
        const timerDisplay = document.getElementById('timer');

        // Quiz State
        let startTime;
        let timerInterval;

        // Function to shuffle an array in place (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Timer functions
        function updateTimerDisplay() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = Date.now();
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Renders the quiz questions to the page
        function renderQuiz() {
            questionsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            retakeQuizBtn.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            gameContainer.style.display = 'none';
            quizContainer.style.display = 'block';

            const optionLabels = ['A', 'B', 'C', 'D'];
            const shuffledQuestions = shuffleArray([...allQuestions]);

            shuffledQuestions.forEach((q, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = q.id;
                questionDiv.className = 'question p-6 rounded-lg shadow-md bg-white border border-gray-200';

                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-lg mb-4';
                questionText.innerHTML = `${questionIndex + 1}. ${q.questionText}`;
                questionDiv.appendChild(questionText);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-4 text-sm sm:text-base';
                questionDiv.appendChild(optionsDiv);

                const shuffledOptions = shuffleArray([...q.options]);
                shuffledOptions.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'question-option block bg-gray-50 p-4 rounded-lg border border-gray-200';
                    const input = document.createElement('input');
                    input.type = q.type;
                    input.name = q.id;
                    input.value = option.value;
                    input.className = 'mr-3';

                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${optionLabels[index]}. ${option.text}`));

                    label.addEventListener('click', () => {
                        if (input.type === 'radio') {
                            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                                radio.parentElement.classList.remove('selected');
                            });
                            label.classList.add('selected');
                        }
                    });
                    optionsDiv.appendChild(label);
                });
                questionsContainer.appendChild(questionDiv);
            });
            startTimer();
        }

        // Event Listeners for quiz
        submitBtn.addEventListener('click', () => {
            let score = 0;
            let totalQuestions = 0;
            let allAnswered = true;

            document.querySelectorAll('.question-option').forEach(label => {
                label.classList.remove('selected', 'correct-answer', 'incorrect-answer');
            });

            questionsContainer.querySelectorAll('.question').forEach(question => {
                const questionId = question.id;
                const labels = question.querySelectorAll('.question-option');
                const selected = question.querySelector('input[type="radio"]:checked');
                const correctAnswerValue = correctAnswers[questionId];

                if (!selected) {
                    allAnswered = false;
                    return;
                }

                totalQuestions++;
                labels.forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === correctAnswerValue) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selected && selected.value === correctAnswerValue) {
                    score++;
                } else if (selected) {
                    selected.parentElement.classList.add('incorrect-answer');
                }
            });

            if (!allAnswered) {
                showBasicMessage("Please answer all questions before submitting.");
                return;
            }

            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%).`;
            resultsDiv.classList.remove('hidden');
            retakeQuizBtn.classList.remove('hidden');

            if (score === totalQuestions) {
                stopTimer(); // Stop the timer on a perfect score
                const finalTime = timerDisplay.textContent;
                scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%). You completed the quiz in ${finalTime}.`;
                resultsDiv.classList.add('bg-green-100', 'text-green-700');
                resultsDiv.classList.remove('bg-red-100', 'text-red-700');
                startGameBtn.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('bg-red-100', 'text-red-700');
                resultsDiv.classList.remove('bg-green-100', 'text-green-700');
            }
        });

        retakeQuizBtn.addEventListener('click', () => {
            renderQuiz();
        });

        startGameBtn.addEventListener('click', () => {
            quizContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            initGame();
        });

        // Simple message box to replace alert()
        function showBasicMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'modal-overlay';
            messageBox.innerHTML = `
                <div class="modal-content text-center bg-yellow-50 border-4 border-yellow-400">
                    <p class="text-gray-800 text-lg sm:text-xl mb-4 font-semibold">${message}</p>
                    <button class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- BART'S SKATEBOARD SCURRY GAME LOGIC (UNCHANGED) ---

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameTimerDisplay = document.getElementById('game-timer');
        const gameOverModal = document.getElementById('game-over-modal');
        const modalTitleText = document.getElementById('modal-title-text');
        const modalBodyText = document.getElementById('modal-body-text');
        const playAgainBtn = document.getElementById('playAgainBtn');

        // Game constants
        const sidewalkHeight = 60;
        const playerWidth = 30;
        const playerHeight = 60;
        const playerDuckHeight = 30;
        const jumpPower = -12;
        const gravity = 0.6;
        const obstacleWidth = 20;
        const groundObstacleHeight = 40; // Hydrant
        const airObstacleHeight = 30; // Branch
        
        // Game state variables
        let player;
        let obstacles;
        let gameSpeed;
        let timer;
        let isDucking;
        let keys;
        let gameInterval;
        // let timerInterval; // This was the duplicate declaration
        let spawnInterval;

        function resizeCanvas() {
            const container = document.getElementById('game-canvas-container');
            // Set canvas size based on its container
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // Initialize player state
        function initPlayer() {
            return {
                x: 50,
                y: canvas.height - sidewalkHeight - playerHeight,
                width: playerWidth,
                height: playerHeight,
                velocityY: 0,
                isGrounded: true
            };
        }

        // Draw the player (Bart)
        function drawPlayer() {
            ctx.fillStyle = '#FFD900'; // Simpsons Yellow
            const currentHeight = isDucking ? playerDuckHeight : player.height;
            const currentY = isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y;
            ctx.fillRect(player.x, currentY, player.width, currentHeight);
        }

        // Draw all obstacles
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.type === 'ground' ? '#E53E3E' : '#8B4513'; // Red (hydrant) or Brown (branch)
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });
        }

        // Update player position (jumping and gravity)
        function updatePlayer() {
            player.velocityY += gravity;
            player.y += player.velocityY;
            player.isGrounded = false;

            // Don't fall through the floor
            const floor = canvas.height - sidewalkHeight - (isDucking ? playerDuckHeight : player.height);
            if (player.y > floor) {
                player.y = floor;
                player.velocityY = 0;
                player.isGrounded = true;
            }
        }

        // Update obstacle positions and check for collisions
        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obstacle = obstacles[i];
                obstacle.x -= gameSpeed;

                // Remove if off-screen
                if (obstacle.x + obstacle.width < 0) {
                    obstacles.splice(i, 1);
                    continue;
                }

                // Collision detection
                const playerRect = {
                    x: player.x,
                    y: isDucking ? (canvas.height - sidewalkHeight - playerDuckHeight) : player.y,
                    width: player.width,
                    height: isDucking ? playerDuckHeight : player.height
                };

                if (
                    playerRect.x < obstacle.x + obstacle.width &&
                    playerRect.x + playerRect.width > obstacle.x &&
                    playerRect.y < obstacle.y + obstacle.height &&
                    playerRect.y + playerRect.height > obstacle.y
                ) {
                    endGame(false); // Player lost
                    return;
                }
            }
        }

        // Spawn new obstacles
        function spawnObstacle() {
            if (gameInterval) { // Only spawn if game is running
                const type = Math.random() < 0.5 ? 'ground' : 'air';
                let obstacle = {
                    x: canvas.width,
                    width: obstacleWidth,
                    type: type
                };

                if (type === 'ground') {
                    obstacle.y = canvas.height - sidewalkHeight - groundObstacleHeight;
                    obstacle.height = groundObstacleHeight;
                } else { // air
                    obstacle.y = canvas.height - sidewalkHeight - playerHeight - airObstacleHeight; // Positioned for ducking
                    obstacle.height = airObstacleHeight;
                }
                obstacles.push(obstacle);
            }
        }
        
        // Main game loop
        function updateGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear sky
            
            // Draw sidewalk
            ctx.fillStyle = '#a0aec0';
            ctx.fillRect(0, canvas.height - sidewalkHeight, canvas.width, sidewalkHeight);

            updatePlayer();
            drawPlayer();
            updateObstacles();
            drawObstacles();
        }

        // End the game (win or lose)
        function endGame(didWin) {
            clearInterval(gameInterval);
            if (timerInterval) clearInterval(timerInterval); // Check if timerInterval exists before clearing
            clearInterval(spawnInterval);
            gameInterval = null;

            if (didWin) {
                modalTitleText.textContent = "Cowabunga!";
                modalBodyText.textContent = "You survived for 60 seconds! Victory Royale!";
            } else {
                modalTitleText.textContent = "D'oh!";
                modalBodyText.textContent = "You crashed! Try again to get the Victory Royale.";
            }
            gameOverModal.classList.remove('hidden');
        }

        // Start a new game
        function startGame() {
            // Clear any old intervals
            if (gameInterval) clearInterval(gameInterval);
            if (timerInterval) clearInterval(timerInterval);
            if (spawnInterval) clearInterval(spawnInterval);

            resizeCanvas(); // Set canvas size
            
            player = initPlayer();
            obstacles = [];
            gameSpeed = 4;
            timer = 60;
            isDucking = false;
            keys = {};
            gameTimerDisplay.textContent = `TIME: ${timer}`;
            gameOverModal.classList.add('hidden');

            // Start game intervals
            gameInterval = setInterval(updateGame, 1000 / 60); // 60 FPS
            
            // Timer interval
            timerInterval = setInterval(() => {
                timer--;
                gameTimerDisplay.textContent = `TIME: ${timer}`;
                
                // Increase difficulty
                if (timer === 45) {
                    gameSpeed = 5;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1800);
                }
                if (timer === 30) {
                    gameSpeed = 6;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1500);
                }
                if (timer === 15) {
                    gameSpeed = 7;
                    clearInterval(spawnInterval);
                    spawnInterval = setInterval(spawnObstacle, 1200);
                }

                // Win condition
                if (timer <= 0) {
                    endGame(true); // Player won
                }
            }, 1000);

            // Initial obstacle spawn
            spawnInterval = setInterval(spawnObstacle, 2000);
        }

        // Handle keyboard input
        function handleKeyInput(e) {
            if (e.code === 'ArrowUp') {
                e.preventDefault();
                if (player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                if (player.isGrounded) {
                    isDucking = true;
                }
            }
        }
        
        function handleKeyRelease(e) {
             if (e.code === 'ArrowDown') {
                e.preventDefault();
                isDucking = false;
            }
        }
        
        // Handle mobile button input
        function handleTouch(key, isDown) {
             if (key === 'ArrowUp') {
                if (isDown && player.isGrounded && !isDucking) {
                    player.velocityY = jumpPower;
                }
            } else if (key === 'ArrowDown') {
                if (isDown && player.isGrounded) {
                    isDucking = true;
                } else {
                    isDucking = false;
                }
            }
        }

        // This function is called when the "Start Game" button is clicked
        function initGame() {
            // Set up event listeners
            document.addEventListener('keydown', handleKeyInput);
            document.addEventListener('keyup', handleKeyRelease);
            
            // Mobile controls
            const upBtn = document.getElementById('up-btn');
            const downBtn = document.getElementById('down-btn');

            // Mouse events
            upBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('mousedown', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('mouseup', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });
            downBtn.addEventListener('mouseleave', (e) => { handleTouch('ArrowDown', false); });

            // Touch events
            upBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowUp', true); });
            downBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('ArrowDown', true); });
            downBtn.addEventListener('touchend', (e) => { e.preventDefault(); handleTouch('ArrowDown', false); });

            playAgainBtn.addEventListener('click', startGame);
            
            // Resize canvas once on init, and start the game
            resizeCanvas();
            startGame();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            // Add a resize listener to resize the canvas if the window changes
            window.addEventListener('resize', () => {
                if (gameInterval) {
                    resizeCanvas();
                }
            });
        });
    </script>
</body>

</html>
