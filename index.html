<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Story of the Mad World of Pandora Quiz</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .question-option {
            transition: all 0.2s;
            cursor: pointer;
        }

        .question-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question-option.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }

        .question-option.correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .question-option.incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .game-font {
            font-family: 'Bangers', cursive;
        }

        /* Styles for the Vault Hunter's game */
        #game-canvas {
            background-color: #333;
            border: 4px solid #f5f5f5;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        #game-info {
            background-color: #222;
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid #555;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(34, 34, 34, 0.95);
            padding: 2.5rem;
            border: 4px solid #f5f5f5;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.4);
            text-align: center;
            z-index: 1000;
            border-radius: 15px;
        }

        .message-box button {
            background-color: #f59e0b;
            color: #1a1a1a;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .message-box button:hover {
            background-color: #d97706;
            transform: scale(1.05);
        }

        .control-button {
            @apply bg-gray-700 text-white p-4 rounded-xl text-2xl font-bold transition-transform transform active:scale-95;
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight on tap */
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 sm:p-10 mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">The Story of the Mad World of Pandora Quiz</h1>
        <p class="text-gray-600 text-center mb-8">Read the passage. Then answer the questions.</p>

        <!-- Timer Section -->
        <div id="timer-container" class="bg-gray-100 p-4 rounded-lg text-center mb-6">
            <p class="text-sm font-semibold text-gray-600">Time Elapsed:</p>
            <p id="timer" class="text-2xl font-bold text-blue-600 mt-1">0:00</p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-container">
            <div id="passage" class="bg-gray-50 rounded-lg p-6 mb-10 text-gray-700 leading-relaxed text-sm sm:text-base border border-gray-200">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4">Passage:</h2>
                <p class="mb-4">Once upon a time, on a planet far, far away from any magical kingdoms, there was a group of brave people called "game creators." Their home was a place called Gearbox Software, and their job was to dream up entire new worlds for others to explore. But their biggest adventure wasn't in a game, it was in making a game!</p>

                <p class="mb-4">They had a grand plan for a new adventure story. They wanted to create a wild, dusty planet called Pandora, filled with brave heroes called Vault Hunters and dangerous creatures. Their first idea was to make the world look very, very real. The guns would look exactly like real guns, and the monsters would be super detailed and gritty, like something you'd see in a movie. The team worked for a long time, drawing and coding and building this realistic world. They were getting close to finishing, but something just didn't feel right. The game was okay, but it didn’t have a special feeling that would make it stand out from all the other games that looked the same. It was a little bit boring.</p>

                <p class="mb-4">The world they created was good, but it wasn't special. It didn't pop with excitement or feel as wacky as the ideas they had in their heads. One day, a brilliant person on the team had a wild thought. "What if," they asked, "we changed the whole thing?" This was a very risky idea. It's like building an entire house and then deciding to repaint every single wall just before you move in! But they believed in their idea. The head of the company, a man named Randy Pitchford, trusted his team and gave them the courage to try something completely different. Instead of making it look real, what if they made it look like a cartoon? Or even better, a living, breathing comic book?</p>

                <p class="mb-4">They decided to be brave and take the risk. They took all their super-realistic drawings and turned them into something new. They gave everything a thick, black outline, like a drawing you would make with a marker. The colors became brighter and bolder. The characters, who once looked like regular people, now had big, wild hair and crazy clothes that looked like they jumped right off a comic book page. The monsters, who were once scary, now had goofy faces and big, silly eyes. The whole world of Pandora went from being a gray and serious place to a mad, colorful, and fun adventure. This new art style was so special it had a name: cel-shading. It made the game look completely unique.</p>

                <p class="mb-4">This big change was the most important part of their journey. It's what made Borderlands unlike any other game. The brave decision to switch to a cartoonish style gave them the freedom to create a world where a hero could punch a bad guy and his head would explode into a shower of candy! It allowed them to create talking robots and wild vehicles and a giant dragon-like creature at the end of the game. All of these things might not have felt right in a "realistic" game, but in their new comic-book world, they fit perfectly. They also filled the game with lots of humor, from silly jokes told by a tiny robot named Claptrap to funny names on all the guns you could find.</p>

                <p class="mb-4">And speaking of guns, the most famous part of Borderlands is its crazy amount of weapons. The creators decided there wouldn't just be a few guns, or even a hundred guns. They wanted to have a bazillion guns! They created a system where the game could put different parts together to make a new and unique gun almost every time. This meant that every time you found a gun, it was a special surprise. You might find a gun that shoots fire, one that talks, or one that makes enemies float into the sky.</p>

                <p class="mb-4">The game creators worked together as a team, with each person adding their own special part to the grand story. The writers wrote funny jokes for the characters to say. The artists drew thousands of new guns and crazy costumes. The coders made sure every jump, every shot, and every explosion worked perfectly. It wasn't just one person who made the game; it was everyone at Gearbox Software working together to bring this big, wild idea to life. And because of their hard work, and their brave decision to be different, they created a game that millions of people love. The story of Borderlands teaches us that sometimes, the best ideas come from being a little bit silly and a lot bit brave. It’s a reminder that even when you think you're done, the best part of the adventure might be just around the corner.</p>
            </div>

            <div id="questions-container" class="space-y-10">
                <!-- Questions will be dynamically inserted here by JavaScript -->
            </div>

            <div class="mt-10 text-center space-x-4">
                <button id="submitBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-600 transition duration-300">
                    Check Answers
                </button>
            </div>
        </div>

        <div id="results" class="mt-8 p-6 rounded-lg text-center font-bold text-lg hidden">
            <p id="scoreText"></p>
            <div class="mt-4 space-x-4">
                <button id="startGameBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 hidden">
                    Congratulations! Check out your reward
                </button>
                <button id="retakeQuizBtn" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-400 transition duration-300 hidden">
                    Retake Quiz
                </button>
            </div>
        </div>

        <hr class="my-12 border-gray-300">

        <!-- Game Section -->
        <div id="game-container" class="flex flex-col items-center justify-center min-h-[500px] p-4 bg-gray-900 rounded-lg shadow-2xl" style="display: none;">
            <div id="game-info" class="mb-6 w-full max-w-xl text-center text-white bg-gray-800 p-4 rounded-xl border-2 border-yellow-400">
                <h1 class="text-3xl font-bold mb-2 game-font">Vault Hunter's Treasure</h1>
                <p class="text-gray-300">Use the arrow keys to move and the <strong class="text-yellow-400">E key</strong> to investigate for key fragments!</p>
                <div class="mt-4 text-xl">
                    Key Fragments Found: <span id="foundCount" class="font-bold text-yellow-400">0</span> / 3
                </div>
            </div>
            <div id="game-canvas-container" class="relative w-full max-w-xl aspect-square overflow-hidden rounded-lg">
                <canvas id="game-canvas" class="w-full h-full"></canvas>
            </div>
            
            <!-- Mobile Controls -->
            <div id="mobile-controls" class="sm:hidden flex flex-col items-center mt-6 w-full">
                <div class="grid grid-cols-3 gap-2 w-48">
                    <div class="col-span-1"></div>
                    <button id="up-btn" class="control-button">▲</button>
                    <div class="col-span-1"></div>
                    <button id="left-btn" class="control-button">◀</button>
                    <div class="col-span-1"></div>
                    <button id="right-btn" class="control-button">▶</button>
                    <div class="col-span-1"></div>
                    <button id="down-btn" class="control-button">▼</button>
                    <div class="col-span-1"></div>
                </div>
                <button id="investigateBtn" class="bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-full mt-6 hover:bg-yellow-500 transition duration-300 w-48">
                    Investigate
                </button>
            </div>

            <div id="end-game-message" class="message-box hidden text-white">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">Congratulations, Vault Hunter!</h2>
                <div id="completed-key-container" class="mb-6 flex justify-center"></div>
                <p class="mb-6 text-lg sm:text-xl">You have successfully completed the vault key. What knowledge will you seek?</p>
                <button id="playAgainBtn">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Quiz Data
        const allQuestions = [{
            id: 'q1',
            questionText: 'What is the main idea of this story?',
            options: [{
                value: 'B',
                text: 'It is a story about a brave team making a video game.'
            }, {
                value: 'C',
                text: 'It is a story about a talking robot.'
            }, {
                value: 'A',
                text: 'It is a story about the planet Pandora.'
            }, {
                value: 'D',
                text: 'It is a story about a video game with many guns.'
            }],
            type: 'radio'
        }, {
            id: 'q2',
            questionText: 'How did the bold decision to change the art style affect the game?',
            options: [{
                value: 'B',
                text: 'It gave the creators freedom to add many silly and wild ideas.'
            }, {
                value: 'A',
                text: 'It made the game look more realistic.'
            }, {
                value: 'C',
                text: 'It made the game more boring and less exciting.'
            }, {
                value: 'D',
                text: 'It made the game feel more serious.'
            }],
            type: 'radio'
        }, {
            id: 'q3',
            questionText: 'Based on the passage, what is the most likely reason the creators felt the game was "a little bit boring?"',
            options: [{
                value: 'C',
                text: 'It did not have a special feeling that would make it stand out.'
            }, {
                value: 'A',
                text: 'The guns were not realistic enough.'
            }, {
                value: 'B',
                text: 'The characters had wild hair and crazy clothes.'
            }, {
                value: 'D',
                text: 'The game had too many explosions.'
            }],
            type: 'radio'
        }, {
            id: 'q4',
            questionText: 'Read this sentence from the passage: "They wanted to have a bazillion guns!" What does the word "bazillion" mean in this sentence?',
            options: [{
                value: 'B',
                text: 'A large, crazy amount'
            }, {
                value: 'A',
                text: 'A special type of gun'
            }, {
                value: 'C',
                text: 'A very small number'
            }, {
                value: 'D',
                text: 'A new kind of monster'
            }],
            type: 'radio'
        }, {
            id: 'q5',
            questionText: 'According to the passage, who was the leader that trusted his team to change the game?',
            options: [{
                value: 'B',
                text: 'Randy Pitchford'
            }, {
                value: 'A',
                text: 'The writer'
            }, {
                value: 'C',
                text: 'Claptrap'
            }, {
                value: 'D',
                text: 'The head of the company'
            }],
            type: 'radio'
        }, {
            id: 'q6',
            questionText: 'What happened right before the game creators decided to change the art style?',
            options: [{
                value: 'A',
                text: 'A brilliant person had a wild thought.'
            }, {
                value: 'B',
                text: 'They finished the game and released it.'
            }, {
                value: 'C',
                text: 'They began to create the bazillion guns.'
            }, {
                value: 'D',
                text: 'The game became very popular.'
            }],
            type: 'radio'
        }];

        const correctAnswers = {
            q1: "B",
            q2: "B",
            q3: "C",
            q4: "B",
            q5: "B",
            q6: "A"
        };

        // DOM elements
        const submitBtn = document.getElementById('submitBtn');
        const retakeQuizBtn = document.getElementById('retakeQuizBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('scoreText');
        const questionsContainer = document.getElementById('questions-container');
        const quizContainer = document.getElementById('quiz-container');
        const gameContainer = document.getElementById('game-container');
        const timerDisplay = document.getElementById('timer');
        const investigateBtn = document.getElementById('investigateBtn');

        // Quiz State
        let startTime;
        let timerInterval;

        // Function to shuffle an array in place (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Timer functions
        function updateTimerDisplay() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            startTime = Date.now();
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Renders the quiz questions to the page
        function renderQuiz() {
            questionsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            retakeQuizBtn.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            gameContainer.style.display = 'none';
            quizContainer.style.display = 'block';

            const optionLabels = ['A', 'B', 'C', 'D'];
            const shuffledQuestions = shuffleArray([...allQuestions]);

            shuffledQuestions.forEach((q, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = q.id;
                questionDiv.className = 'question p-6 rounded-lg shadow-md bg-white border border-gray-200';

                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-lg mb-4';
                questionText.innerHTML = `${questionIndex + 1}. ${q.questionText}`;
                questionDiv.appendChild(questionText);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-4 text-sm sm:text-base';
                questionDiv.appendChild(optionsDiv);

                const shuffledOptions = shuffleArray([...q.options]);
                shuffledOptions.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'question-option block bg-gray-50 p-4 rounded-lg border border-gray-200';
                    const input = document.createElement('input');
                    input.type = q.type;
                    input.name = q.id;
                    input.value = option.value;
                    input.className = 'mr-3';

                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${optionLabels[index]}. ${option.text}`));

                    label.addEventListener('click', () => {
                        if (input.type === 'radio') {
                            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
                                radio.parentElement.classList.remove('selected');
                            });
                            label.classList.add('selected');
                        }
                    });
                    optionsDiv.appendChild(label);
                });
                questionsContainer.appendChild(questionDiv);
            });
            startTimer();
        }

        // Event Listeners for quiz
        submitBtn.addEventListener('click', () => {
            let score = 0;
            let totalQuestions = 0;
            let allAnswered = true;

            document.querySelectorAll('.question-option').forEach(label => {
                label.classList.remove('selected', 'correct-answer', 'incorrect-answer');
            });

            questionsContainer.querySelectorAll('.question').forEach(question => {
                const questionId = question.id;
                const labels = question.querySelectorAll('.question-option');
                const selected = question.querySelector('input[type="radio"]:checked');
                const correctAnswerValue = correctAnswers[questionId];

                if (!selected) {
                    allAnswered = false;
                    return;
                }

                totalQuestions++;
                labels.forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === correctAnswerValue) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selected && selected.value === correctAnswerValue) {
                    score++;
                } else if (selected) {
                    selected.parentElement.classList.add('incorrect-answer');
                }
            });

            if (!allAnswered) {
                // Use a simple message box to inform the user
                showBasicMessage("Please answer all questions before submitting.");
                return;
            }

            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%).`;
            resultsDiv.classList.remove('hidden');
            retakeQuizBtn.classList.remove('hidden');

            if (score === totalQuestions) {
                stopTimer(); // Stop the timer on a perfect score
                const finalTime = timerDisplay.textContent;
                scoreText.textContent = `You scored ${score} out of ${totalQuestions} (${percentage.toFixed(0)}%). You completed the quiz in ${finalTime}.`;
                resultsDiv.classList.add('bg-green-100', 'text-green-700');
                resultsDiv.classList.remove('bg-red-100', 'text-red-700');
                startGameBtn.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('bg-red-100', 'text-red-700');
                resultsDiv.classList.remove('bg-green-100', 'text-green-700');
            }
        });

        retakeQuizBtn.addEventListener('click', () => {
            renderQuiz();
        });

        startGameBtn.addEventListener('click', () => {
            quizContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            initGame();
        });

        // Simple message box to replace alert()
        function showBasicMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box flex flex-col items-center';
            messageBox.innerHTML = `
                <p class="text-white text-lg sm:text-xl mb-4">${message}</p>
                <button class="bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-300">OK</button>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // Game Logic for Vault Hunter's Treasure
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const foundCountEl = document.getElementById('foundCount');
        const messageBox = document.getElementById('end-game-message');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const completedKeyContainer = document.getElementById('completed-key-container');
        const upBtn = document.getElementById('up-btn');
        const downBtn = document.getElementById('down-btn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const hunterSize = 50;
        let hunterX, hunterY;
        const speed = 5;
        let foundKeys = 0;
        let isGameActive = false;
        let animationFrameId;

        const hunterSymbol = '🤠';
        const keyFragmentImages = [];
        let objects = [];
        const numObjects = 10;
        const objectSymbols = ['📦', '💰', '🛡️', '⚙️', '💎', '🧪'];

        const keys = {};

        // SVG functions
        function createDiamondFragmentSVG(fragmentIndex) {
            const svgWidth = 50;
            const svgHeight = 50;
            let svgPath = '';
            if (fragmentIndex === 0) {
                svgPath = `M${svgWidth / 2},0 L0,${svgHeight / 2} L${svgWidth / 2},${svgHeight * 0.75} L${svgWidth},${svgHeight / 2} Z`;
            } else if (fragmentIndex === 1) {
                svgPath = `M0,${svgHeight / 2} L${svgWidth / 2},${svgHeight * 0.75} L${svgWidth / 2},${svgHeight} L0,${svgHeight} Z`;
            } else if (fragmentIndex === 2) {
                svgPath = `M${svgWidth},${svgHeight / 2} L${svgWidth / 2},${svgHeight * 0.75} L${svgWidth / 2},${svgHeight} L${svgWidth},${svgHeight} Z`;
            }
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}">
                        <path d="${svgPath}" fill="#a855f7" stroke="#8b5cf6" stroke-width="2" />
                    </svg>`;
        }

        function createCompletedDiamondSVG() {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
                        <path d="M50,0 L0,50 L50,100 L100,50 Z" fill="#a855f7" stroke="#8b5cf6" stroke-width="4" />
                    </svg>`;
        }

        function preloadKeyFragments() {
            for (let i = 0; i < 3; i++) {
                const keyFragImage = new Image();
                const svgString = createDiamondFragmentSVG(i);
                keyFragImage.src = 'data:image/svg+xml;base64,' + btoa(svgString);
                keyFragmentImages.push(keyFragImage);
            }
        }

        function showGameMessage() {
            completedKeyContainer.innerHTML = createCompletedDiamondSVG();
            messageBox.classList.remove('hidden');
        }

        function hideGameMessage() {
            messageBox.classList.add('hidden');
        }

        // Game state and object creation
        function createObjects() {
            objects = [];
            const keyLocations = new Set();
            while (keyLocations.size < 3) {
                keyLocations.add(Math.floor(Math.random() * numObjects));
            }

            for (let i = 0; i < numObjects; i++) {
                let x, y;
                let overlap;
                do {
                    overlap = false;
                    x = Math.random() * (canvas.width - 50);
                    y = Math.random() * (canvas.height - 50);

                    for (const obj of objects) {
                        const dist = Math.sqrt(Math.pow(x - obj.x, 2) + Math.pow(y - obj.y, 2));
                        if (dist < 100) {
                            overlap = true;
                            break;
                        }
                    }
                } while (overlap);

                objects.push({
                    x: x,
                    y: y,
                    isKey: keyLocations.has(i),
                    isFound: false,
                    symbol: objectSymbols[Math.floor(Math.random() * objectSymbols.length)]
                });
            }
        }

        function resetGame() {
            foundKeys = 0;
            foundCountEl.textContent = foundKeys;
            hunterX = canvas.width / 2 - hunterSize / 2;
            hunterY = canvas.height / 2 - hunterSize / 2;
            hideGameMessage();
            createObjects();
            isGameActive = true;
            if (!animationFrameId) {
                gameLoop();
            }
        }

        // Game drawing logic
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            objects.forEach(obj => {
                ctx.save();
                ctx.translate(obj.x, obj.y);
                if (obj.isFound) {
                    const foundKeyCount = objects.filter(o => o.isFound).length;
                    const fragIndex = obj.isKey ? objects.filter(o => o.isKey).indexOf(obj) : -1;
                    if (fragIndex !== -1 && keyFragmentImages[fragIndex]?.complete) {
                        ctx.drawImage(keyFragmentImages[fragIndex], 0, 0, 50, 50);
                    }
                } else {
                    ctx.font = '40px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(obj.symbol, 25, 25);
                }
                ctx.restore();
            });

            ctx.font = '50px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(hunterSymbol, hunterX + hunterSize / 2, hunterY + hunterSize / 2);
        }

        // Game logic
        function investigate() {
            if (!isGameActive) return;
            let foundSomething = false;
            objects.forEach(obj => {
                if (!obj.isFound &&
                    hunterX < obj.x + 50 &&
                    hunterX + hunterSize > obj.x &&
                    hunterY < obj.y + 50 &&
                    hunterY + hunterSize > obj.y) {
                    if (obj.isKey) {
                        obj.isFound = true;
                        foundKeys++;
                        foundSomething = true;
                        foundCountEl.textContent = foundKeys;
                        if (foundKeys === 3) {
                            showGameMessage();
                            isGameActive = false;
                        }
                    }
                }
            });
            draw();
        }

        function gameLoop() {
            if (!isGameActive) return;

            if (keys['ArrowUp']) hunterY -= speed;
            if (keys['ArrowDown']) hunterY += speed;
            if (keys['ArrowLeft']) hunterX -= speed;
            if (keys['ArrowRight']) hunterX += speed;

            hunterX = Math.max(0, Math.min(canvas.width - hunterSize, hunterX));
            hunterY = Math.max(0, Math.min(canvas.height - hunterSize, hunterY));

            draw();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Event Listeners for game
        document.addEventListener('keydown', (e) => {
            if (!isGameActive) return;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
                keys[e.key] = true;
            }
            if (e.key.toLowerCase() === 'e' || e.key === ' ') {
                investigate();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!isGameActive) return;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                keys[e.key] = false;
            }
        });

        // Touch/Mouse event listeners for new buttons
        const controlButtons = {
            'up-btn': 'ArrowUp',
            'down-btn': 'ArrowDown',
            'left-btn': 'ArrowLeft',
            'right-btn': 'ArrowRight'
        };

        function startMovement(e) {
            e.preventDefault();
            const key = controlButtons[e.currentTarget.id];
            if (key) keys[key] = true;
        }

        function stopMovement(e) {
            e.preventDefault();
            const key = controlButtons[e.currentTarget.id];
            if (key) keys[key] = false;
        }

        Object.keys(controlButtons).forEach(id => {
            const btn = document.getElementById(id);
            btn.addEventListener('mousedown', startMovement);
            btn.addEventListener('mouseup', stopMovement);
            btn.addEventListener('mouseleave', stopMovement); // Prevents movement from getting stuck if cursor moves off button
            btn.addEventListener('touchstart', startMovement);
            btn.addEventListener('touchend', stopMovement);
        });

        investigateBtn.addEventListener('click', investigate);
        playAgainBtn.addEventListener('click', () => {
            // New logic to return to the quiz
            hideGameMessage(); // Hide the "You Win!" message box
            gameContainer.style.display = 'none'; // Hide the game section
            quizContainer.style.display = 'block'; // Show the quiz section
            renderQuiz(); // Reset the quiz and restart the timer
        });

        function resizeCanvas() {
            const container = document.getElementById('game-canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            resetGame();
        }

        function initGame() {
            preloadKeyFragments();
            resizeCanvas();
            isGameActive = true;
            gameLoop();
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            window.addEventListener('resize', () => {
                if (gameContainer.style.display === 'flex') {
                    resizeCanvas();
                }
            });
        });
    </script>
</body>

</html>
